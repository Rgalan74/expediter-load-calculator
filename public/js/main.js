// √¢≈ì‚Ä¶ main.js - VERSI√É‚ÄúN CORREGIDA SIN BUCLE INFINITO

// Estado global de la aplicaci√É¬≥n
let appState = {
  currentTab: 'calculator',
  isLoading: false
};
// Control para evitar repetici√É¬≥n de debug
window.hasDebuggedFinances = false;

// ‚úÖ HELPER FUNCTION - Esperar a que una funci√≥n est√© disponible (resuelve race conditions)
function waitForFunction(funcName, timeout = 5000) {
  return new Promise((resolve, reject) => {
    const start = Date.now();
    let attempts = 0;
    
    const check = () => {
      attempts++;
      const elapsed = Date.now() - start;
      
      if (typeof window[funcName] === 'function') {
        console.log(`‚úÖ [MAIN] Function '${funcName}' available after ${attempts} attempts (${elapsed}ms)`);
        resolve();
      } else if (elapsed > timeout) {
        console.warn(`‚ö†Ô∏è [MAIN] Timeout: '${funcName}' not available after ${timeout}ms`);
        reject(new Error(`Timeout waiting for ${funcName}`));
      } else {
        setTimeout(check, 50); // Revisar cada 50ms
      }
    };
    
    check();
  });
}

// √¢≈ì‚Ä¶ FUNCI√É‚ÄúN PRINCIPAL - openTab (MEJORADA)
function openTab(tabId) {
  console.log(`√∞≈∏‚Äù‚Äû [MAIN] Opening tab: ${tabId}`);
  
  try {
    if (appState.isLoading) {
      console.log("[MAIN] App is loading, ignoring tab change");
      return;
    }
    
    // Ocultar todas las tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
      tab.classList.remove('tab-active');
      tab.classList.add('hidden');
    });
    
    // Mostrar la tab seleccionada
    const targetTab = document.getElementById(tabId);
    if (targetTab) {
      targetTab.classList.add('tab-active');
      targetTab.classList.remove('hidden');
      appState.currentTab = tabId;
      console.log(`√¢≈ì‚Ä¶ [MAIN] Tab ${tabId} activated`);
    } else {
      console.error(`√¢¬ù≈í [MAIN] Tab element not found: ${tabId}`);
      return;
    }

    // √¢≈ì‚Ä¶ CARGAR DATOS CON VERIFICACI√É‚ÄúN DE USUARIO
    if (window.currentUser) {
      loadTabData(tabId);
    } else {
      console.warn(`√¢≈°¬†√Ø¬∏¬è [MAIN] No user available for tab ${tabId}, will load when user is ready`);
    }
    
  } catch (error) {
    console.error(`√¢¬ù≈í [MAIN] Error opening tab ${tabId}:`, error);
    showMessage("Error al cambiar de pesta√É¬±a", "error");
  }
}

// √¢≈ì‚Ä¶ FUNCI√É‚ÄúN MEJORADA - Cargar datos de tab
async function loadTabData(tabId) {
  console.log(`√∞≈∏‚Äú‚Äö [MAIN] Loading data for tab: ${tabId}`);
  
  // Verificar que la tab est√É¬© visible
  const tabElement = document.getElementById(tabId);
  if (!tabElement || tabElement.classList.contains('hidden')) {
    console.log(`√¢≈°¬†√Ø¬∏¬è [MAIN] Tab ${tabId} not visible, skipping data load`);
    return;
  }

  if (!window.currentUser && tabId !== 'calculator') {
    console.log(`√¢≈°¬†√Ø¬∏¬è [MAIN] No user available for ${tabId}, skipping data load`);
    return;
  }

  try {
    switch (tabId) {
      case 'calculator':
        console.log("√∞≈∏‚Äú≈† [MAIN] Calculator tab - no data loading needed");
        break;
        
      case 'history':
        console.log("√∞≈∏‚Äú‚Äπ [MAIN] Loading history data...");
        if (typeof getLoadHistory === 'function') getLoadHistory();
        break;

      case 'finances':
        console.log("üí∞ [MAIN] Tab Finanzas abierta, activando Resumen...");
        initPeriodSelectors("global");

        // ‚úÖ La carga de datos ahora usa cach√© inteligente
        const y = document.getElementById('yearSelect')?.value;
        const m = document.getElementById('monthSelect')?.value;
        const period = (y && m) ? `${y}-${String(m).padStart(2,'0')}` : "all";

        // ‚úÖ SOLUCI√ìN RACE CONDITION: Esperar a que loadFinancesData est√© disponible
        try {
          console.log("üí∞ [MAIN] Esperando loadFinancesData...");
          await waitForFunction('loadFinancesData', 5000);
          
          console.log("üí∞ [MAIN] Auto-cargando Finanzas con per√≠odo:", period);
          const result = await window.loadFinancesData(period);
          
          updateFinancialKPIs(result.kpis);
          updateExpenseCategories();
          renderExpensesList(result.expenses);
          updateFinancialCharts("global");
          updateBusinessMetrics();
          
          console.log("‚úÖ [MAIN] Datos financieros cargados exitosamente");
        } catch (err) {
          console.error("‚ùå [MAIN] Error cargando datos financieros:", err);
          if (typeof showMessage === 'function') {
            showMessage("Error al cargar datos financieros. Por favor recarga la p√°gina.", "error");
          }
        }
        break;

      case 'reports':
        console.log("√∞≈∏¬ß¬æ [MAIN] Opening Finances REPORTS tab");
        setTimeout(() => {
          initPeriodSelectors("reports");
          if (typeof generatePLReport === "function") generatePLReport();
        }, 200);
        break;

      case 'accounts':
        console.log("√∞≈∏‚Äô¬µ [MAIN] Opening Finances ACCOUNTS tab");
        setTimeout(() => {
          initPeriodSelectors("accounts");
          if (typeof loadAccountsData === "function") loadAccountsData();
        }, 200);
        break;

      case 'zones':
        console.log("√∞≈∏‚Äî¬∫√Ø¬∏¬è [MAIN] Loading zones data...");
        if (typeof loadZonesData === 'function') loadZonesData();
        break;

      case 'settings':
        console.log("√¢≈°‚Ñ¢√Ø¬∏¬è [MAIN] Loading settings...");
        if (typeof loadSettings === 'function') loadSettings();
        break;

      default:
        console.log(`√∞≈∏¬§¬∑ [MAIN] No specific handler for tab: ${tabId}`);
    }
  } catch (error) {
    console.error(`√¢¬ù≈í [MAIN] Error loading data for tab ${tabId}:`, error);
    if (typeof showMessage === 'function') {
      showMessage(`Error cargando ${tabId}`, "error");
    }
  }
}



// √¢≈ì‚Ä¶ Setup navegaci√É¬≥n
function setupNavigation() {
  console.log("√∞≈∏≈°‚Ç¨ [MAIN] Setting up navigation");
  
  const tabButtons = document.querySelectorAll(".tab-link, .tab-btn:not(.dropdown-finanzas .tab-btn)");
  
  tabButtons.forEach((btn) => {
    const tabId = btn.getAttribute("data-tab");

    // √∞≈∏‚Äò‚Ä∞ Si no tiene data-tab, ignorar el bot√É¬≥n (ej: Finanzas √¢‚Äì¬æ)
    if (!tabId) {
      console.log("[MAIN] Tab button missing data-tab attribute, skipping:", btn);
      return;
    }

    btn.addEventListener("click", (e) => {
  e.preventDefault();
  console.log(`√∞≈∏‚ÄùÀú [MAIN] Tab button clicked: ${tabId}`);
  
  // Actualizar estado visual
  updateTabButtonState(btn);
  
  // Abrir la tab correspondiente
  openTab(tabId);

  // √¢≈ì‚Ä¶ Si el bot√É¬≥n pertenece al men√É¬∫ desplegable de Finanzas √¢‚Ä†‚Äô cerrar men√É¬∫
  const dropdown = document.querySelector(".dropdown-finanzas");
  if (dropdown && dropdown.contains(btn)) {
    dropdown.classList.add("hidden");
    console.log("√∞≈∏‚Äú‚Äö [MAIN] Dropdown de Finanzas cerrado tras seleccionar:", tabId);
  }
  if (btn.classList.contains("tab-btn")) {
  const parentDropdown = btn.closest(".dropdown-finanzas");
  if (parentDropdown) {
    parentDropdown.querySelectorAll(".tab-btn").forEach((subBtn) => {
      subBtn.classList.remove("bg-blue-50", "text-blue-600", "font-bold");
    });
    btn.classList.add("bg-blue-50", "text-blue-600", "font-bold");
  }
}

});

  });

  console.log("√¢≈ì‚Ä¶ [MAIN] Navigation setup completed");
}
// √¢≈ì‚Ä¶ Toggle para el men√É¬∫ de Finanzas usando posici√É¬≥n FIXED
document.addEventListener("DOMContentLoaded", () => {
  const finanzasBtn = document.getElementById("finanzasMenuBtn");
  const dropdown = document.querySelector(".dropdown-finanzas");

  if (finanzasBtn && dropdown) {
    finanzasBtn.addEventListener("click", (e) => {
      e.preventDefault();

      // Calcular posici√É¬≥n bajo el bot√É¬≥n
      const rect = finanzasBtn.getBoundingClientRect();
      dropdown.style.top = `${rect.bottom + 5}px`; // 5px de espacio
      dropdown.style.left = `${rect.left}px`;

      dropdown.classList.toggle("hidden");
    });

    // √∞≈∏‚Äò‚Ä∞ Cerrar al hacer click fuera
    document.addEventListener("click", (e) => {
      if (!finanzasBtn.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.classList.add("hidden");
      }
    });
  }
});



function updateTabButtonState(activeButton) {
  // Remover estado activo de todos los botones
  document.querySelectorAll(".tab-link").forEach((b) => {
    b.classList.remove("text-blue-600", "font-bold");
    b.classList.add("text-gray-700");
  });
  
  // Activar el bot√É¬≥n seleccionado
  activeButton.classList.remove("text-gray-700");
  activeButton.classList.add("text-blue-600", "font-bold");
}

// √¢≈ì‚Ä¶ Setup del logout button
function setupLogout() {
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', async () => {
      console.log("√∞≈∏≈°¬™ [MAIN] Logging out...");
      
      try {
        if (auth) {
          await auth.signOut();
          console.log("√¢≈ì‚Ä¶ [MAIN] User signed out successfully");
          window.location.href = 'auth.html';
        }
      } catch (error) {
        console.error("√¢¬ù≈í [MAIN] Error signing out:", error);
        showMessage("Error al cerrar sesi√É¬≥n", "error");
      }
    });
    console.log("√¢≈ì‚Ä¶ [MAIN] Logout button configured");
  }
}

// √¢≈ì‚Ä¶ Setup inicial de la app
function setupInitialApp() {
  console.log("√∞≈∏≈°‚Ç¨ [MAIN] Setting up initial app...");
  
  try {
    setupNavigation();
    setupLogout();
    
    // Setup tab inicial (calculadora)
    const defaultBtn = document.querySelector('[data-tab="calculator"]');
    if (defaultBtn) {
      updateTabButtonState(defaultBtn);
      openTab("calculator");
      console.log("√∞≈∏≈°‚Ç¨ [MAIN] Tab inicial abierta: calculator");
    }
    
    console.log("√¢≈ì‚Ä¶ [MAIN] Initial app setup completed");
  } catch (error) {
    console.error("√¢¬ù≈í [MAIN] Error during app setup:", error);
  }
  // √¢≈ì‚Ä¶ Avisar que main.js ya termin√É¬≥ de inicializar
window.mainJsReady = true;
document.dispatchEvent(new Event("mainJsReady"));
if (typeof debugLog === "function") {
  debugLog("√∞≈∏≈°‚Ç¨ mainJsReady disparado desde main.js");
} else {
  console.log("√∞≈∏≈°‚Ç¨ mainJsReady disparado desde main.js");
}


}

// √¢≈ì‚Ä¶ FUNCI√É‚ÄúN MEJORADA - loadInitialData
function loadInitialData() {
  console.log("√∞≈∏‚Äù‚Äû [MAIN] Loading initial data after authentication");
  
  if (window.currentUser && appState.currentTab) {
    console.log(`√∞≈∏‚Äú‚Äö [MAIN] Loading data for current tab: ${appState.currentTab}`);
    loadTabData(appState.currentTab);
  } else {
    console.warn("√¢≈°¬†√Ø¬∏¬è [MAIN] Cannot load initial data:", {
      user: !!window.currentUser,
      currentTab: appState.currentTab
    });
  }
}

// √¢≈ì‚Ä¶ FUNCI√É‚ÄúN DE DEBUG SIMPLIFICADA (ADAPTADA A 3 SUBTABS)
function debugFinancesSetup() {
  console.log("√∞≈∏‚Äù¬ç [MAIN] === DEBUGGING FINANCES SETUP ===");
  console.log("√∞≈∏‚Äú‚Äπ DOM elements check:");
  
  const criticalElements = [
    // Resumen
    'yearSelect',
    'monthSelect',

    // Reportes
    'reportYear',
    'reportMonth',

    // Cuentas
    'accountsYear',
    'accountsMonth',

    // KPIs y gr√É¬°ficos
    'totalRevenue', 
    'totalExpenses', 
    'netProfit',
    'profitMarginPercent',
    'cashFlowChart',
    'expenseBreakdownChart'
  ];
  
  criticalElements.forEach(id => {
    const element = document.getElementById(id);
    console.log(`  ${id}: ${element ? '√¢≈ì‚Ä¶ Found' : '√¢¬ù≈í Missing'}`);
  });
  
  console.log("√∞≈∏‚Äù¬ß Functions check:");
  console.log(`  loadFinancesData: ${typeof loadFinancesData}`);
  console.log(`  firebase: ${typeof firebase}`);
  console.log(`  Chart: ${typeof Chart}`);
  
  console.log("√∞≈∏‚Äò¬§ User check:");
  console.log(`  currentUser: ${window.currentUser?.email || 'null'}`);
  
  console.log("=====================================");
}

// √¢≈ì‚Ä¶ Event listeners para refrescar cuando se guarde una carga
document.addEventListener('loadSaved', () => {
  console.log("√∞≈∏‚Äù‚Äû [MAIN] Load saved, refreshing current tab data");
  if (window.currentUser && appState.currentTab) {
    loadTabData(appState.currentTab);
  }
});

// √¢≈ì‚Ä¶ NUEVO EVENT LISTENER - Cuando el usuario se autentica
document.addEventListener('userStateChanged', (event) => {
  const { user } = event.detail || {};
  console.log("√∞≈∏‚Äò¬§ [MAIN] User state changed:", user?.email || 'logged out');
  
  if (user) {
    console.log("√¢≈ì‚Ä¶ [MAIN] User authenticated, loading current tab data");
    setTimeout(() => {
      loadInitialData();
    }, 1000);
  }
});

// √¢≈ì‚Ä¶ Inicializaci√É¬≥n cuando DOM est√É¬© listo
document.addEventListener("DOMContentLoaded", () => {
  console.log("√∞≈∏≈°‚Ç¨ [MAIN] DOM loaded - Setting up app");
  
  // Setup inmediato
  setupInitialApp();
});

// √¢≈ì‚Ä¶ Debug utilities MEJORADAS (SIN BUCLES)
window.appState = appState;
window.debugApp = () => {
  console.log("√∞≈∏¬ê‚Ä∫ [MAIN] Debug:", {
    currentTab: appState.currentTab,
    currentUser: window.currentUser?.email || 'null',
    availableFunctions: {
      getLoadHistory: typeof getLoadHistory,
      loadDashboardData: typeof loadDashboardData,
      loadFinancesData: typeof loadFinancesData,
      loadZonesData: typeof loadZonesData,
      openTab: typeof openTab
    },
    domElements: {
      financesPeriodSelect: !!document.getElementById('financesPeriodSelect'),
      totalRevenue: !!document.getElementById('totalRevenue'),
      cashFlowChart: !!document.getElementById('cashFlowChart')
    },
    libraries: {
      firebase: typeof firebase,
      Chart: typeof Chart
    }
  });
};

// Comentar o eliminar esta funci√É¬≥n que est√É¬° en bucle infinito
/*
window.debugFinances = () => {
  if (!window.hasDebuggedFinances) {
    debugFinancesSetup();
    window.hasDebuggedFinances = true;
  }
  console.log("Manual debug completed. To load finances manually, run:");
  console.log("window.loadFinancesData()");
};
*/


// √¢≈ì‚Ä¶ FUNCI√É‚ÄúN MANUAL PARA CARGAR FINANZAS
window.manualLoadFinances = () => {
  if (typeof loadFinancesData === 'function' && window.currentUser) {
    console.log("√∞≈∏¬ß¬™ [MAIN] Manual finances load...");
    loadFinancesData();
  } else {
    console.error("√¢¬ù≈í [MAIN] Cannot load finances manually:", {
      function: typeof loadFinancesData,
      user: !!window.currentUser
    });
  }
};

// √¢≈ì‚Ä¶ Submen√É¬∫ interno de Finanzas
document.addEventListener("DOMContentLoaded", () => {
  const subtabButtons = document.querySelectorAll(".fin-subtab");
  const subtabContents = document.querySelectorAll(".fin-subcontent");

function activateSubtab(target) {
  console.log("√∞≈∏‚Äù≈Ω DEBUG activateSubtab √¢‚Ä†‚Äô target:", target);

  // Resetear botones
  subtabButtons.forEach(b => b.classList.remove("bg-blue-100", "font-semibold"));
  const btn = document.querySelector(`.fin-subtab[data-subtab='${target}']`);
  if (btn) {
    btn.classList.add("bg-blue-100", "font-semibold");
  }

  // Mostrar solo el contenido seleccionado
  subtabContents.forEach(c => c.classList.add("hidden"));
  const content = document.getElementById(`finances-${target}`);
  console.log("√∞≈∏‚Äú≈í DEBUG subtab content:", content);
  if (content) {
    content.classList.remove("hidden");
  }

  console.log(`√∞≈∏‚Äú‚Äö [FINANCES] Subtab activado: ${target}`);

  if (target === "summary") {
  console.log("√∞≈∏‚Äô¬∞ [FINANCES] Entrando a summary");
  initPeriodSelectors("global");
  setTimeout(() => {
    console.log("√∞≈∏‚Äô¬∞ [FINANCES] Ejecutando loadFinancesData desde summary");
    window.loadFinancesData?.("all");
  }, 200);
}


  if (target === "reports") {
    console.log("√∞≈∏¬ß¬æ [FINANCES] Entrando a reports");
    initPeriodSelectors("reports");
    if (typeof generatePLReport === "function") {
      generatePLReport();
    } else {
      console.warn("√¢≈°¬†√Ø¬∏¬è generatePLReport no existe");
    }
  }

  if (target === "accounts") {
    console.log("√∞≈∏‚Äô¬µ [FINANCES] Entrando a accounts");
    initPeriodSelectors("accounts");
    if (typeof loadAccountsData === "function") {
      loadAccountsData();
    } else {
      console.warn("√¢≈°¬†√Ø¬∏¬è loadAccountsData no existe");
    }
  }
}


  // Evento click en botones
  subtabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.getAttribute("data-subtab");
      activateSubtab(target);
    });
  });

  // √¢≈ì‚Ä¶ Mostrar "Resumen" por defecto al entrar en Finanzas
  document.addEventListener("financesOpened", () => {
    activateSubtab("summary");
  });
});
