<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- 📱 PWA / Mobile -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <!-- Note: theme-color works in Chrome/Safari/Edge, not Firefox/Opera -->
  <meta name="theme-color" content="#3b82f6">
  <meta name="apple-mobile-web-app-title" content="Expediter Load Calculator">

  <!-- 📝 SEO -->
  <meta name="description"
    content="Panel de control para expediteros. Calcula cargas, visualiza zonas, historial y estadísticas.">
  <meta name="author" content="Galan Cargo Express">

  <!-- 🔖 Título -->
  <title>App | Expediter Load Calculator</title>

  <!-- 📷 Icono -->
  <link rel="icon" type="image/png" href="img/logo-app.png">

  <!-- 🎨 Google Fonts - Inter (Professional typography) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800;900&family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet">

  <!-- 🎨 Estilos -->
  <link rel="stylesheet" href="css/design-system.css">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/mobile-styles.css?v=2.8.0">
  <link rel="stylesheet" href="css/mobile-typography.css">
  <link rel="stylesheet" href="css/mobile-header-fix.css?v=1.8.0">
  <link rel="stylesheet" href="css/mobile-content-width.css?v=1.6.0">
  <link rel="stylesheet" href="css/app.css?v=3.0.0">
  <link rel="stylesheet" href="css/zones-print.css">
  <link rel="stylesheet" href="css/calculator-decision.css?v=1.0.0">
  <link rel="stylesheet" href="css/ui-enhancements.css?v=1.0.0">
  <link rel="stylesheet" href="css/onboarding.css?v=1.0.1">
  <link rel="stylesheet" href="css/select-options-fix.css">
  <link rel="stylesheet" href="css/print-styles.css">
  <link rel="stylesheet" href="css/report-modal-styles.css">
  <!-- MOBILE CALCULATOR FIX - Must load LAST to override all other styles -->
  <link rel="stylesheet" href="css/mobile-calculator-fix.css?v=1.0.0">



</head>

<body class="bg-gray-100 text-gray-900">
  <!-- Loading Screen (Default visible) -->
  <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex items-center justify-center flex-col">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
    <img src="img/logo-app.png" alt="Expediter" class="h-12 w-12 rounded-full absolute animate-pulse">
    <p class="text-gray-500 text-sm font-medium mt-16 animate-pulse">Cargando...</p>
  </div>

  <!-- Login Screen (Hidden by default) -->
  <div id="loginScreen" class="text-center mt-20 text-gray-600 text-xl hidden">
    <p>Inicia sesión para acceder a tu cuenta</p>
  </div>

  <!-- App Content (Hidden by default) -->
  <div id="appContent" class="hidden">
    <!-- Header -->
    <header class="w-full z-50 bg-white shadow">
      <div class="max-w-7xl mx-auto px-2 py-2 md:px-4 md:py-4 flex items-center justify-between">

        <!-- Logo + Nombre - Optimizado mobile -->
        <div class="flex items-center gap-1 md:gap-2">
          <picture>
            <source srcset="img/logo-app.webp" type="image/webp">
            <img src="img/logo-app.png" alt="Logo"
              class="w-9 h-9 md:w-16 md:h-16 rounded-full border border-gray-300 shadow">
          </picture>
          <span class="text-base md:text-3xl font-bold text-gray-900 header-title whitespace-nowrap">
            Load Calculator
          </span>
        </div>

        <!-- Botones de acción - Gap reducido mobile -->
        <div class="flex items-center gap-1 md:gap-3 md:justify-between md:w-auto ml-auto">

          <!-- Botón hamburguesa (solo móvil, izquierda) -->
          <button id="menuToggle" class="md:hidden text-gray-800 focus:outline-none text-3xl leading-none">
            ☰
          </button>

          <!-- 👑 BADGE DE ROL (visible cuando se carga) -->
          <div id="roleBadge"
            class="hidden items-center px-2 py-0.5 md:px-3 md:py-1.5 rounded-full text-xs font-bold border-2 transition-all">
            <span id="roleBadgeIcon" class="mr-0.5 md:mr-1 hidden md:inline"></span>
            <span id="roleBadgeText" class="uppercase md:tracking-wide"></span>
          </div>

          <!-- Botón Planes - Solo icono en mobile -->
          <a id="upgradePlanBtn" href="/plans.html"
            class="text-indigo-600 hover:text-indigo-800 font-medium text-sm border border-indigo-200 bg-indigo-50 hover:bg-indigo-100 px-2 py-1 md:px-3 md:py-1.5 rounded transition-colors flex items-center">
            <span>💎</span>
            <span class="hidden md:inline ml-1">Mejorar Plan</span>
          </a>

          <!-- Botón logout (siempre a la derecha) -->
          <button id="logoutBtn" class="p-1 bg-transparent border-0 hover:opacity-70 
               md:bg-white md:hover:bg-gray-50 md:text-red-600 
               md:border-2 md:border-red-500 md:hover:border-red-600 
               md:px-4 md:py-2 md:rounded md:text-sm md:font-medium 
               flex items-center gap-2 ml-auto transition-all focus:outline-none">
            <!-- Ícono más pequeño en mobile -->
            <svg class="w-6 h-6 md:w-8 md:h-8" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" stroke="white" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
              <polyline points="16 17 21 12 16 7" stroke="white" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
              <line x1="21" y1="12" x2="9" y2="12" stroke="white" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
            <!-- Texto solo en desktop -->
            <span class="hidden md:inline text-base">Cerrar sesión</span>
          </button>
        </div>

      </div>

      <!-- ✅ MODAL PARA CREAR CATEGORÍA PERSONALIZADA -->
      <div id="categoryModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">

          <!-- Modal Header -->
          <div class="border-b border-gray-200 px-6 py-4 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">➕ Nueva Categoría de Gasto</h3>
            <button type="button" onclick="closeCategoryModal()" class="text-gray-400 hover:text-gray-600">
              <span class="text-2xl">&times;</span>
            </button>
          </div>

          <!-- Modal Body -->
          <div class="px-6 py-4">
            <div class="space-y-4">

              <!-- Nombre -->
              <div>
                <label for="categoryName" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la
                  Categoría</label>
                <input type="text" id="categoryName" placeholder="Ej: Préstamos, Marketing, etc."
                  class="border border-gray-300 rounded px-3 py-2 w-full focus:border-purple-500 focus:outline-none"
                  maxlength="30" required>
              </div>

              <!-- Icono (selector simple) -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ícono</label>
                <div id="iconSelector" class="grid grid-cols-8 gap-2">
                  <!-- Íconos comunes -->
                  <button type="button"
                    class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                    onclick="selectIcon('💳')">💳</button>
                  <button type="button"
                    class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                    onclick="selectIcon('💰')">💰</button>
                  <button type="button"
                    class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                    onclick="selectIcon('💻')">💻</button>
                  <button type="button"
                    class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                    onclick="selectIcon('📱')">📱</button>
                  <button type="button"
                    class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                    onclick="selectIcon('🏦')">🏦</button>
                  <button type="button"
                    class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                    onclick="selectIcon('🏠')">🏠</button>
                  <button type="button"
                    class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                    onclick="selectIcon('🎓')">🎓</button>
                  <button type="button"
                    class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                    onclick="selectIcon('⚡')">⚡</button>
                  <button type="button"
                    class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                    onclick="selectIcon('🔧')">🔧</button>
                  <button type="button"
                    class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                    onclick="selectIcon('🛠️')">🛠️</button>
                  <button type="button"
                    class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                    onclick="selectIcon('📦')">📦</button>
                  <button type="button"
                    class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                    onclick="selectIcon('🎯')">🎯</button>
                  <button type="button"
                    class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                    onclick="selectIcon('📊')">📊</button>
                  <button type="button"
                    class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                    onclick="selectIcon('💡')">💡</button>
                  <button type="button"
                    class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                    onclick="selectIcon('🚀')">🚀</button>
                  <button type="button"
                    class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                    onclick="selectIcon('⭐')">⭐</button>
                </div>
                <input type="hidden" id="selectedIcon" value="📌">
              </div>

              <!-- Color -->
              <div>
                <label for="categoryColor" class="block text-sm font-medium text-gray-700 mb-1">Color (opcional)</label>
                <input type="color" id="categoryColor" value="#6b7280"
                  class="border border-gray-300 rounded px-3 py-2 w-full h-10">
              </div>

            </div>
          </div>

          <!-- Modal Footer -->
          <div class="border-t border-gray-200 px-6 py-4 flex flex-col sm:flex-row gap-3 sm:justify-end">
            <button type="button" onclick="closeCategoryModal()"
              class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 order-2 sm:order-1">
              Cancelar
            </button>
            <button type="button" onclick="saveCustomCategory()"
              class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 order-1 sm:order-2">
              💾 Crear Categoría
            </button>
          </div>

        </div>
      </div>




      <!-- Navigation tabs (solo desktop) -->
      <nav class="hidden md:block border-t border-gray-200 bg-white relative overflow-visible">
        <div class="max-w-7xl mx-auto px-2 md:px-6 flex gap-2 md:gap-8 py-2 md:py-3 overflow-x-auto">

          <!-- Calculadora -->
          <button
            class="tab-link text-gray-700 font-bold hover:text-blue-600 text-sm md:text-lg px-2 md:px-3 py-2 rounded-md whitespace-nowrap"
            data-tab="calculator">
            <span class="md:hidden">📊</span>
            <span class="hidden md:inline">Calculadora</span>
            <span class="md:hidden ml-1">Calc</span>
          </button>

          <!-- Historial -->
          <button
            class="tab-link text-gray-700 font-bold hover:text-blue-600 text-sm md:text-lg px-2 md:px-3 py-2 rounded-md whitespace-nowrap"
            data-tab="history">
            <span class="md:hidden">📋</span>
            <span class="hidden md:inline">Historial</span>
            <span class="md:hidden ml-1">Hist</span>
          </button>

          <!-- Finanzas -->
          <button
            class="tab-link text-gray-700 font-bold hover:text-blue-600 text-sm md:text-lg px-2 md:px-3 py-2 rounded-md whitespace-nowrap"
            data-tab="finances">
            <span class="md:hidden">💰</span>
            <span class="hidden md:inline">Finanzas</span>
            <span class="md:hidden ml-1">Fins</span>
          </button>

          <!-- Zonas -->
          <button
            class="tab-link text-gray-700 font-bold hover:text-blue-600 text-sm md:text-lg px-2 md:px-3 py-2 rounded-md whitespace-nowrap"
            data-tab="zones">
            <span class="md:hidden">🗺️</span>
            <span class="hidden md:inline">Zonas</span>
            <span class="md:hidden ml-1">Map</span>
          </button>

          <!-- Configuración -->
          <button
            class="tab-link text-gray-700 font-bold hover:text-blue-600 text-sm md:text-lg px-2 md:px-3 py-2 rounded-md whitespace-nowrap"
            data-tab="settings">
            <span class="md:hidden">⚙️</span>
            <span class="hidden md:inline">Configuración</span>
            <span class="md:hidden ml-1">Set</span>
          </button>

        </div>
      </nav>


      <div id="mobileMenu" class="md:hidden hidden flex-col px-4 pb-4 space-y-2 bg-white text-sm font-semibold text-gray-900 shadow
            transform transition-all duration-300 ease-in-out origin-top scale-y-0 opacity-0">
        <button class="tab-link text-left w-full hover:text-blue-600" data-tab="calculator">📊 Calculadora</button>
        <button class="tab-link text-left w-full hover:text-blue-600" data-tab="history">📋 Historial</button>
        <button class="tab-link text-left w-full hover:text-blue-600" data-tab="finances">💰 Finanzas</button>
        <button class="tab-link text-left w-full hover:text-blue-600" data-tab="zones">🗺️ Zonas</button>
        <button class="tab-link text-left w-full hover:text-blue-600" data-tab="settings">⚙️ Configuración</button>

        <!-- Separador -->
        <div class="border-t border-gray-200 my-2"></div>

        <!-- Logout - Destacado en rojo -->
        <button id="mobileLogoutBtn" onclick="logout()"
          class="text-left w-full text-red-600 hover:text-red-700 font-bold border border-red-300 bg-red-50 hover:bg-red-100 rounded-md px-3 py-2 transition-colors">
          🚪 Cerrar Sesión
        </button>
      </div>
    </header>


    <!-- Global Messages -->
    <div id="globalMessage" class="hidden"></div>
    <div id="historyMessage" class="hidden"></div>


    <!-- Main Content -->
    <main class="w-full px-4 mt-6">
      <!-- Calculator Tab -->
      <section id="calculator" class="tab-content">
        <div class="w-full px-6 py-6 space-y-8">

          <!-- Encabezado -->
          <div class="section-header text-center">
            <h2 class="font-bold mb-4">📊 Calculadora de Cargas</h2>
            <p class="subtitle">Cálculos con decisión automática</p>
          </div>

          <!-- Indicador de configuración (populated by onboarding-manager) -->
          <div id="configStatusIndicator"></div>

          <!-- Grid padre de las 3 tarjetas -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- 📍 Información de Ruta -->
            <div class="card-section lg:col-span-2">
              <h3 class="text-2xl font-bold mb-4">📍 Información de Ruta</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

                <!-- Origen y destino -->
                <div class="space-y-4">
                  <input class="border p-3 w-full rounded-lg text-base placeholder:text-sm" id="origin"
                    placeholder="Origen (ej: Miami, FL)">

                  <!-- DESTINOS DINÁMICOS - Container -->
                  <div id="destinationsContainer" class="space-y-3">
                    <!-- Los destinos se agregarán aquí dinámicamente -->
                  </div>

                  <!-- Botón Añadir Destino -->
                  <button type="button" id="addDestinationBtn" onclick="addDestination()"
                    class="w-full bg-purple-100 hover:bg-purple-200 text-purple-700 font-semibold py-3 px-3 rounded-lg border-2 border-purple-300 transition flex items-center justify-center gap-2 text-base">
                    <span class="text-lg">+</span> Añadir destino
                  </button>

                  <!-- Hidden Destino field for backward compatibility -->
                  <input type="hidden" id="destination">
                </div>

                <!-- Empresa + Notas -->
                <div class="space-y-4">
                  <input class="border p-3 w-full rounded-lg text-base placeholder:text-sm" id="companyName"
                    placeholder="Empresa (opcional)">

                  <input class="border p-3 w-full rounded-lg text-base placeholder:text-sm" id="loadNumber"
                    placeholder="Número de Carga (opcional)">

                  <!-- 📝 Notas previas (CRUD) -->
                  <!-- 📌 Cuadro amarillo en calculadora -->
                  <div id="previousNoteBox"
                    class="p-3 rounded-lg bg-yellow-50 border border-yellow-200 text-sm text-gray-800 hidden">
                    <p id="notesStatusText">ℹ️ No hay notas para este destino.</p>
                    <button onclick="openNotesModal(document.getElementById('destination').value)"
                      class="mt-2 bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                      📖 Ver Notas
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- 📏 Información de Millas -->
            <div class="card-section col-span-1">
              <h3 class="text-2xl font-bold mb-4">📏 Información de Millas</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-base font-medium mb-2">Millas Cotizadas *</label>
                  <input type="number" id="loadedMiles" placeholder="644"
                    class="border p-3 w-full rounded-lg text-base">
                  <p class="text-xs mt-1">Incluye loaded + deadhead to pickup</p>
                </div>
                <div>
                  <label class="block text-base font-medium mb-2">Millas Vacías (opcional)</label>
                  <input type="number" id="deadheadMiles" placeholder="0"
                    class="border p-3 w-full rounded-lg text-base">
                  <p class="text-xs mt-1">Solo si necesitas separar deadhead</p>
                </div>
                <div>
                  <label class="block text-base font-medium mb-2">Total Millas</label>
                  <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-3 text-center">
                    <span id="tripMiles" class="text-2xl font-bold text-blue-800">0</span>
                    <span class="text-blue-600 text-sm ml-1">millas</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- 💰 Finanzas -->
            <div class="card-section col-span-1">
              <h3 class="text-2xl font-bold mb-4">💰 Información Financiera</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-base font-medium mb-2">RPM ($/milla) *</label>
                  <input type="number" id="rpm" step="0.01" placeholder="2.20"
                    class="border p-3 w-full rounded-lg text-base">
                </div>
                <div>
                  <label class="block text-base font-medium mb-2">Rate ($)</label>
                  <input type="number" id="rate" step="0.01" placeholder="800"
                    class="border p-3 w-full rounded-lg text-base">
                </div>
                <div>
                  <label class="block text-base font-medium mb-2">Tolls ($)</label>
                  <input type="number" id="tolls" placeholder="25" class="border p-3 w-full rounded-lg text-base">
                </div>
                <div>
                  <label class="block text-base font-medium mb-2">Otros Costos ($)</label>
                  <input type="number" id="otherCosts" placeholder="0" class="border p-3 w-full rounded-lg text-base">
                </div>
              </div>
            </div>
          </div>

          <!-- Panel de Decisión Nuevo -->
          <div id="decisionPanel" class="hidden mt-6">
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden decision-panel">

              <!-- HEADER DINÁMICO -->
              <div id="decisionHeader" class="p-4 md:p-5">
                <div class="flex items-start md:items-center justify-between mb-3 gap-2">
                  <div class="flex items-start md:items-center gap-2 md:gap-3 flex-1">
                    <span id="decisionIcon" class="text-3xl md:text-4xl">⚡</span>
                    <div class="flex-1">
                      <h3 id="decisionTitle" class="text-xl md:text-2xl font-bold">CALCULANDO...</h3>
                      <p id="decisionRoute" class="text-white/90 text-xs md:text-sm mt-0.5 md:mt-1"></p>
                    </div>
                  </div>
                  <div class="text-right flex-shrink-0">
                    <div class="text-xs text-white/80">Cotización</div>
                    <div id="quickPrice" class="text-2xl md:text-3xl font-bold">$0</div>
                  </div>
                </div>

                <!-- Grid métricas -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-3 mb-3">
                  <div class="bg-white/20 backdrop-blur rounded-lg p-2 text-center">
                    <div class="text-xs text-white/80">RPM</div>
                    <div id="quickRPM" class="text-lg md:text-xl font-bold">$0.00</div>
                  </div>
                  <div class="bg-white/20 backdrop-blur rounded-lg p-2 text-center">
                    <div class="text-xs text-white/80">Ganancia</div>
                    <div id="quickNetProfit" class="text-lg md:text-xl font-bold">$0</div>
                  </div>
                  <div class="bg-white/20 backdrop-blur rounded-lg p-2 text-center">
                    <div class="text-xs text-white/80">Margen</div>
                    <div id="quickMargin" class="text-lg md:text-xl font-bold">0%</div>
                  </div>
                  <div class="bg-white/20 backdrop-blur rounded-lg p-2 text-center">
                    <div class="text-xs text-white/80">$/Mi</div>
                    <div id="quickProfitPerMile" class="text-lg md:text-xl font-bold">$0.00</div>
                  </div>
                </div>

                <!-- Badges -->
                <div id="decisionBadges" class="flex gap-1.5 md:gap-2 text-xs md:text-sm flex-wrap"></div>
              </div>

              <!-- CONTENIDO -->
              <div class="p-4 md:p-5">

                <!-- Costos Variables -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 md:p-4 mb-3 md:mb-4 costs-section">
                  <h4 class="font-bold text-gray-800 mb-2 md:mb-3 text-sm">💸 Costos Variables</h4>
                  <div class="space-y-1.5 md:space-y-2 text-sm">
                    <div class="flex justify-between items-center">
                      <span class="text-gray-700">⛽ Combustible (<span id="totalMilesForFuel">0</span> mi):</span>
                      <strong id="fuelCost" class="text-white">$0.00</strong>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-gray-700">💵 Tolls + Otros:</span>
                      <strong id="tollsAndOthers" class="text-white">$0.00</strong>
                    </div>
                    <div class="flex justify-between items-center text-xs text-gray-500">
                      <span>🔧 Costos Fijos incluidos</span>
                      <span id="fixedCosts" class="text-gray-300">$0.00</span>
                    </div>
                    <hr class="border-gray-300">
                    <div class="flex justify-between items-center font-bold">
                      <span class="text-gray-900">Total Gastos:</span>
                      <span id="totalExpenses" class="text-white text-lg">$0.00</span>
                    </div>
                  </div>
                </div>

                <!-- Ganancia Final -->
                <div id="profitSection" class="border-2 rounded-lg p-3 md:p-4">
                  <div class="flex items-center justify-between">
                    <div class="flex-1">
                      <div class="text-xs mb-1" id="profitLabel">💰 Ganancia Neta</div>
                      <div id="netProfit" class="text-2xl md:text-3xl font-bold">$0.00</div>
                      <div id="profitDetails" class="text-xs mt-1 font-semibold">$0.00/mi • 0% margen</div>
                    </div>
                    <div class="text-right text-xs flex-shrink-0">
                      <div id="estimatedTimeShort" class="text-white font-semibold">⏱️ 0h</div>
                      <div id="fuelStopsShort" class="text-white font-semibold">⛽ 0 paradas</div>
                    </div>
                  </div>
                </div>

                <!-- Botón Lex -->
                <div class="mt-3 md:mt-4 text-center">
                  <button onclick="analyzeLexLoad()"
                    class="bg-gradient-to-r from-blue-600 to-purple-700 text-white px-4 md:px-6 py-2 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-800 transition text-sm w-full md:w-auto min-h-[44px]">
                    🧠 Ver análisis detallado con Lex
                  </button>
                </div>

              </div>

            </div>
          </div>


          <!-- 🔹 Botones de acción -->
          <div class="card-section text-center mt-6">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">

              <!-- Botón Guardar -->
              <button id="saveBtn" class="btn-success">
                💾 Guardar Carga
              </button>
              <button id="clearBtn" class="btn-secondary">
                🧹 Limpiar
              </button>

              <!-- Botón Lex AI -->
              <button id="lexAnalyzeBtn" type="button" onclick="analyzeLexLoad()"
                class="bg-gradient-to-r from-blue-600 to-purple-700 text-white px-4 py-2.5 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-800 transition-all duration-300 shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                <img src="img/lex/lex-thinking.png" class="w-5 h-5" alt="Lex" onerror="this.style.display='none'">
                <span>🧠 Analizar con Lex</span>
              </button>
            </div>
            <div class="mt-4 text-center">
              <div class="text-sm text-gray-700" id="message"></div>
              <div class="text-sm text-red-600" id="errorMessage"></div>
            </div>
          </div>


          <!-- Map Section -->
          <div class="card-section">
            <h3 class="text-xl font-semibold mb-4 text-center">🗺️ Mapa de Ruta</h3>

            <div class="flex flex-wrap gap-2 mb-4 justify-center">
              <button onclick="updateMap()"
                class="bg-blue-500 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-600 shadow-md"
                style="color: white !important;">
                🔄 Actualizar Mapa
              </button>
              <button onclick="openGoogleMapsDirections()"
                class="bg-green-500 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-green-600 shadow-md"
                style="color: white !important;">
                📱 Abrir en Google Maps
              </button>
            </div>

            <div class="relative">
              <div id="map" class="w-full h-96 rounded-lg border-2 border-gray-300 bg-gray-100"></div>
              <div id="mapLoading"
                class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center rounded-lg hidden">
                <div class="text-center">
                  <div class="spinner mx-auto mb-2"></div>
                  <p class="text-gray-600">Cargando mapa...</p>
                </div>
              </div>
            </div>

            <div class="mt-3 text-sm text-gray-600 bg-blue-50 p-3 rounded">
              <p class="flex items-center gap-2">
                <span>🗺️</span>
                <span><strong>Mapa interactivo:</strong> Se muestra la ruta calculada automáticamente</span>
              </p>
            </div>
          </div>
        </div>

        <!-- Settings Helper Functions -->
        <script>
          // Toggle custom state input visibility
          function toggleCustomStateInput() {
            const select = document.getElementById('operatingState');
            const customInput = document.getElementById('customState');
            if (select.value === 'other') {
              customInput.classList.remove('hidden');
            } else {
              customInput.classList.add('hidden');
              customInput.value = ''; // Clear value when hidden
            }
          }

          // Calculate maintenance cost per mile
          function calculateMaintenanceCost() {
            const serviceCost = parseFloat(document.getElementById('maintenanceServiceCost').value);
            const interval = parseFloat(document.getElementById('maintenanceInterval').value);

            if (!serviceCost || !interval || interval === 0) {
              alert('Por favor ingresa valores válidos');
              return;
            }

            const costPerMile = (serviceCost / interval).toFixed(3);
            document.getElementById('maintenancePerMile').value = costPerMile;

            // Show success message
            const summary = document.querySelector('[onclick="calculateMaintenanceCost()"]').closest('details').querySelector('summary');
            const originalText = summary.textContent;
            summary.textContent = '✅ Calculado: $' + costPerMile + '/mi';
            setTimeout(() => { summary.textContent = originalText; }, 3000);
          }

          // Calculate tire cost per mile
          function calculateTireCost() {
            const tireCost = parseFloat(document.getElementById('tireCost').value);
            const lifespan = parseFloat(document.getElementById('tireLifespan').value);

            if (!tireCost || !lifespan || lifespan === 0) {
              alert('Por favor ingresa valores válidos');
              return;
            }

            const costPerMile = (tireCost / lifespan).toFixed(3);
            document.getElementById('tiresPerMile').value = costPerMile;

            // Show success message
            const summary = document.querySelector('[onclick="calculateTireCost()"]').closest('details').querySelector('summary');
            const originalText = summary.textContent;
            summary.textContent = '✅ Calculado: $' + costPerMile + '/mi';
            setTimeout(() => { summary.textContent = originalText; }, 3000);
          }

          // Calculate repair cost per mile
          function calculateRepairCost() {
            const period = document.getElementById('repairPeriod').value;
            const reserve = parseFloat(document.getElementById('repairReserve').value);
            const monthlyMiles = parseFloat(document.getElementById('monthlyMilesGoal')?.value || 8000);

            if (!reserve || reserve === 0) {
              alert('Por favor ingresa un monto de reserva válido');
              return;
            }

            let costPerMile;
            if (period === 'monthly') {
              costPerMile = (reserve / monthlyMiles).toFixed(3);
            } else { // annual
              costPerMile = (reserve / (monthlyMiles * 12)).toFixed(3);
            }

            document.getElementById('repairsPerMile').value = costPerMile;

            // Show success message
            const summary = document.querySelector('[onclick="calculateRepairCost()"]').closest('details').querySelector('summary');
            const originalText = summary.textContent;
            summary.textContent = '✅ Calculado: $' + costPerMile + '/mi';
            setTimeout(() => { summary.textContent = originalText; }, 3000);
          }

          // Update loadVehicleTemplate to handle custom vehicle
          const originalLoadVehicleTemplate = window.loadVehicleTemplate;
          window.loadVehicleTemplate = function (vehicleType) {
            const customInput = document.getElementById('customVehicleType');
            if (vehicleType === 'custom') {
              customInput.classList.remove('hidden');
              // Don't load any template for custom
            } else {
              customInput.classList.add('hidden');
              customInput.value = '';
              // Call original function if it exists
              if (typeof originalLoadVehicleTemplate === 'function') {
                originalLoadVehicleTemplate(vehicleType);
              }
            }
          };
        </script>
      </section>

      <!-- History Tab -->
      <section id="history" class="tab-content hidden">
        <div class="w-full px-3 md:px-6 py-4 md:py-6 space-y-4 md:space-y-8">

          <!-- Header -->
          <div class="section-header text-center">
            <h2 class="font-bold mb-4">📜 Historial de Cargas</h2>
            <p class="subtitle">Administra y analiza tus registros de cargas</p>
          </div>

          <!-- Filters -->
          <div class="card-section">
            <h3 class="text-2xl font-semibold mb-4">🔍 Filtros</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">

              <label for="filterOrigin" class="sr-only">Origen</label>
              <input type="text" id="filterOrigin" name="filterOrigin" class="border p-3 rounded-lg w-full text-base"
                placeholder="Origen">

              <label for="filterDestination" class="sr-only">Destino</label>
              <input type="text" id="filterDestination" name="filterDestination"
                class="border p-3 rounded-lg w-full text-base" placeholder="Destino">

              <label for="historyMonthSelect" class="sr-only">Mes</label>
              <select id="historyMonthSelect" name="historyMonthSelect" class="border p-3 rounded-lg w-full text-base">
                <option value="">Todos los meses</option>
              </select>

              <button id="filterBtn" type="button" class="btn-primary w-full sm:w-auto">
                🔍 Filtrar
              </button>
            </div>
          </div>


          <!-- 📊 Resumen de Estadísticas (Historial) -->
          <div class="card-section">
            <h3 class="text-lg font-semibold mb-4">📊 Resumen de Estadísticas</h3>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
              <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 text-center">
                <h4 class="text-sm font-medium text-indigo-700 mb-1">Total Cargas</h4>
                <p class="kpi-value text-blue-800" id="sumTotal">0</p>
                <p class="text-xs text-indigo-600 mt-1">Cargas completadas</p>
              </div>
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                <h4 class="text-sm font-medium text-yellow-700 mb-1">Millas Totales</h4>
                <p class="kpi-value text-blue-800" id="sumMiles">0</p>
                <p class="text-xs text-yellow-600 mt-1">Distancia recorrida</p>
              </div>
              <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                <h4 class="text-sm font-medium text-green-700 mb-1">Ingresos Totales</h4>
                <p class="kpi-value text-blue-800" id="sumRevenue">$0</p>
                <p class="text-xs text-green-600 mt-1">Monto bruto acumulado</p>
              </div>
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                <h4 class="text-sm font-medium text-blue-700 mb-1">Ganancias Netas</h4>
                <p class="kpi-value text-blue-800" id="sumProfit">$0</p>
                <p class="text-xs text-blue-600 mt-1">Después de gastos</p>
              </div>
              <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                <h4 class="text-sm font-medium text-purple-700 mb-1">RPM Promedio</h4>
                <p class="kpi-value text-blue-800" id="sumRpm">$0</p>
                <p class="text-xs text-purple-600 mt-1">Dólares por milla</p>
              </div>
            </div>
          </div>

          <!-- Table -->
          <div class="card-section">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-4">
              <p class="text-sm text-gray-600 order-2 sm:order-1">
                Mostrando <span id="filteredCount">0</span> de <span id="totalCount">0</span> cargas
              </p>
              <button id="exportExcelBtn" type="button" class="btn-success text-sm px-3 py-2 order-1 sm:order-2"
                style="font-size: 14px !important; color: white !important; -webkit-text-fill-color: white !important;">
                📤 Exportar Excel
              </button>
            </div>
            <!-- Contenedor con altura máxima y scroll (responsive) -->
            <div class="overflow-x-auto overflow-y-auto border border-gray-300 rounded-lg" style="max-height: 400px;">
              <table class="w-full min-w-[800px] text-sm md:text-base">
                <thead class="bg-gray-100 text-gray-700 md:sticky md:top-0 z-10">
                  <tr>
                    <th class="p-2 text-left">Fecha</th>
                    <th class="p-2 text-left">Load #</th>
                    <th class="p-2 text-left">Origen</th>
                    <th class="p-2 text-left">Destino</th>
                    <th class="p-2 text-left">Compañía</th>
                    <th class="p-2 text-left">Millas</th>
                    <th class="p-2 text-left">RPM</th>
                    <th class="p-2 text-left">Tarifa</th>
                    <th class="p-2 text-left">Acciones</th>
                  </tr>
                </thead>
                <tbody id="loadList" class="divide-y divide-gray-200 text-base">
                  <!-- Rows will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>

        </div>
      </section>

      <!-- 📊 Sección Finanzas -->
      <section id="finances" class="tab-content hidden">
        <div class="w-full px-3 md:px-6 py-4 md:py-6 space-y-4 md:space-y-6">

          <!-- Header -->
          <div class="section-header text-center">
            <h2 class="font-bold mb-4">💰 Gestión Financiera</h2>
            <p class="subtitle">Control total de tus ingresos, gastos y rentabilidad</p>
          </div>

          <!-- Submenú interno (Pill Navigation) -->
          <div class="flex justify-center border-b border-gray-100 pb-4 mb-2">
            <div class="inline-flex bg-gray-100 p-1.5 rounded-xl shadow-inner">
              <button
                class="fin-subtab px-4 py-2 rounded-lg text-sm font-medium text-gray-600 hover:text-gray-900 transition-all duration-200"
                data-subtab="summary">🧮 Resumen</button>
              <button
                class="fin-subtab px-4 py-2 rounded-lg text-sm font-medium text-gray-600 hover:text-gray-900 transition-all duration-200"
                data-subtab="reports">🧾 Reportes</button>
              <button
                class="fin-subtab px-4 py-2 rounded-lg text-sm font-medium text-gray-600 hover:text-gray-900 transition-all duration-200"
                data-subtab="accounts">💵 Cuentas</button>
            </div>
          </div>

          <!-- 📊 Contenido RESUMEN -->
          <div id="finances-summary" class="fin-subcontent">

            <!-- ✅ Selector Unificado (Resumen) -->
            <div class="card-section">
              <div class="grid grid-cols-2 md:flex md:flex-row gap-4 items-start md:items-center">
                <!-- Año -->
                <div class="flex items-center gap-2">
                  <label for="yearSelect" class="text-sm font-medium text-gray-700">Año</label>
                  <select id="yearSelect" class="border border-gray-300 rounded px-3 py-2 w-40"></select>
                </div>

                <!-- Mes -->
                <div class="flex items-center gap-2">
                  <label for="monthSelect" class="text-sm font-medium text-gray-700">Mes</label>
                  <select id="monthSelect" class="border border-gray-300 rounded px-3 py-2 w-40"></select>
                </div>

                <!-- Botón -->
                <button
                  class="col-span-2 md:col-span-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm font-medium"
                  onclick="applyPeriod('global')">
                  🔄 Actualizar
                </button>
              </div>
            </div>

            <!-- Info de actualización -->
            <div class="text-right">
              <span id="lastUpdated" class="text-sm text-gray-500">Actualizado: --</span>
            </div>

            <!-- Resumen del período -->
            <div id="periodSummary" class="mt-3 text-sm bg-blue-50 border border-blue-200 rounded p-3 hidden">
              <div class="flex items-center gap-2">
                <span class="text-blue-600">📊</span>
                <span id="periodInfo" class="text-blue-800 font-medium">Analizando datos...</span>
              </div>
            </div>

            <!-- KPIs UNIFICADOS - Todos en una sola fila - Optimizado para mobile -->
            <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-7 gap-2 md:gap-3 mb-6">
              <!-- Ingresos -->
              <div class="bg-green-50 border border-green-200 rounded-lg p-1.5 md:p-2 text-center">
                <h4 class="text-xs font-medium text-green-700 mb-1">Ingresos</h4>
                <p class="text-sm md:text-base font-bold text-green-800" id="totalRevenue">$0.00</p>
              </div>

              <!-- Gastos -->
              <div class="bg-red-50 border border-red-200 rounded-lg p-1.5 md:p-2 text-center">
                <h4 class="text-xs font-medium text-red-700 mb-1">Gastos</h4>
                <p class="text-sm md:text-base font-bold text-red-800" id="totalExpensesSummary">$0.00</p>
              </div>

              <!-- Ganancia -->
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-1.5 md:p-2 text-center">
                <h4 class="text-xs font-medium text-blue-700 mb-1">Ganancia</h4>
                <p class="text-sm md:text-base font-bold text-blue-800" id="netProfit">$0.00</p>
              </div>

              <!-- Millas -->
              <div class="bg-purple-50 border border-purple-200 rounded-lg p-1.5 md:p-2 text-center">
                <h4 class="text-xs font-medium text-purple-700 mb-1">Millas</h4>
                <p class="text-sm md:text-base font-bold text-purple-800" id="totalMiles">0</p>
              </div>

              <!-- RPM -->
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-1.5 md:p-2 text-center">
                <h4 class="text-xs font-medium text-yellow-700 mb-1">RPM</h4>
                <p class="text-sm md:text-base font-bold text-yellow-800" id="avgRpm">$0.00</p>
              </div>

              <!-- Costo por Milla - Ahora compacto e integrado -->
              <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-1.5 md:p-2 text-center">
                <h4 class="text-xs font-medium text-indigo-700 mb-1">$/Milla</h4>
                <p class="text-sm md:text-base font-bold text-indigo-800" id="costPerMile">$0.00</p>
              </div>

              <!-- Eficiencia - Ahora compacto e integrado -->
              <div class="bg-pink-50 border border-pink-200 rounded-lg p-1.5 md:p-2 text-center">
                <h4 class="text-xs font-medium text-pink-700 mb-1">Eficiencia</h4>
                <p class="text-sm md:text-base font-bold text-pink-800" id="efficiency">0%</p>
              </div>
            </div>

            <!-- Gestión de Gastos -->
            <div class="card-section">
              <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-4">
                <h3 class="text-base sm:text-lg font-semibold">💳 Gestión de Gastos</h3>
                <div class="flex flex-col sm:flex-row gap-2">
                  <button onclick="openExpenseModal()" class="bg-green-600 px-3 py-2 rounded hover:bg-green-700 text-sm"
                    style="color: white !important; -webkit-text-fill-color: white !important;">
                    ➕ Agregar Gasto
                  </button>
                  <button onclick="openCategoryModal()"
                    class="bg-purple-600 px-3 py-2 rounded hover:bg-purple-700 text-sm"
                    style="color: white !important; -webkit-text-fill-color: white !important;">
                    ⚙️ Categorías
                  </button>
                </div>
              </div>

              <!-- Lista de gastos recientes -->
              <div class="overflow-x-auto">
                <table class="min-w-full text-sm border border-gray-300">
                  <thead class="bg-gray-100">
                    <tr>
                      <th class="p-2 text-left">Fecha</th>
                      <th class="p-2 text-left">Categoría</th>
                      <th class="p-2 text-left">Descripción</th>
                      <th class="p-2 text-left">Monto</th>
                      <th class="p-2 text-left">Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="expensesList">
                    <tr>
                      <td colspan="5" class="p-4 text-center text-gray-500">
                        No hay gastos registrados para este período
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Gráficos Principales -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- Cash Flow Chart -->
              <div class="card-section">
                <h3 class="text-lg font-semibold mb-4">📈 Rendimiento Financiero</h3>
                <div id="cashFlowChartContainer" class="h-96 bg-gray-50 rounded-lg p-4">
                  <canvas id="cashFlowChart"></canvas>
                </div>
              </div>

              <!-- Expense Breakdown -->
              <div class="card-section">
                <h3 class="text-lg font-semibold mb-4">🥧 Distribución de Gastos</h3>
                <div id="expenseBreakdownChartContainer" class="h-96 bg-gray-50 rounded-lg p-4">
                  <canvas id="expenseBreakdownChart"></canvas>
                </div>
              </div>
            </div>

            <!-- Gráficos del Dashboard Integrados -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
              <!-- RPM Trends -->
              <div class="card-section">
                <h3 class="text-lg font-semibold mb-4">📈 Tendencia RPM</h3>
                <div class="h-80 bg-gray-50 rounded-lg p-4">
                  <canvas id="rpmTrendChart"></canvas>
                </div>
              </div>

              <!-- Distribución de Cargas -->
              <div class="card-section">
                <h3 class="text-lg font-semibold mb-4">🎯 Distribución de Cargas</h3>
                <div class="h-80 bg-gray-50 rounded-lg p-4">
                  <canvas id="loadDistributionChart"></canvas>
                </div>
              </div>
            </div>

          </div>

          <!-- 🧾 Contenido REPORTES -->
          <div id="finances-reports" class="fin-subcontent hidden space-y-6">

            <!-- ✅ Selector Unificado (Reportes) -->
            <div class="card-section">
              <h3 class="text-base font-semibold mb-3" style="color: white !important;">📊 Filtrar Período</h3>
              <div class="grid grid-cols-2 gap-3">
                <!-- Año -->
                <div class="flex flex-col gap-1">
                  <label for="reportYear" class="text-xs font-medium"
                    style="color: rgba(255,255,255,0.8) !important;">Año</label>
                  <select id="reportYear" class="border rounded px-2 py-2 w-full text-sm"></select>
                </div>

                <!-- Mes -->
                <div class="flex flex-col gap-1">
                  <label for="reportMonth" class="text-xs font-medium"
                    style="color: rgba(255,255,255,0.8) !important;">Mes</label>
                  <select id="reportMonth" class="border rounded px-2 py-2 w-full text-sm"></select>
                </div>
              </div>

              <!-- Botón - Full width -->
              <button class="w-full mt-3 bg-blue-600 px-4 py-2 rounded hover:bg-blue-700 text-sm font-medium"
                style="color: white !important;" onclick="applyPeriod('reports')">
                🔄 Actualizar Datos
              </button>
            </div>


            <!-- 📘 Tarjetas de Reportes -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

              <!-- 📊 Reporte Financiero Completo (P&L) -->
              <div class="card-section p-4 rounded-lg"
                style="background: linear-gradient(135deg, rgba(30,58,138,0.8) 0%, rgba(59,130,246,0.6) 100%);">
                <!-- Header -->
                <div class="border-b border-white/20 pb-3 mb-3">
                  <h3 class="text-lg font-bold" style="color: white !important;">
                    📊 Estado de Resultados (P&L)
                  </h3>
                </div>
                <!-- Description -->
                <div class="mb-4">
                  <p class="text-sm mb-2" style="color: rgba(255,255,255,0.85) !important;">
                    Análisis profesional con métricas clave, flujo de efectivo, y tendencias.
                  </p>
                  <div class="text-xs" style="color: rgba(255,255,255,0.6) !important;">
                    ✅ Resumen Ejecutivo<br>
                    ✅ Métricas Operativas<br>
                    ✅ Desglose de Gastos<br>
                    ✅ Análisis de Cargas
                  </div>
                </div>
                <!-- Button -->
                <button onclick="generatePLReport()"
                  class="w-full px-4 py-2 rounded-lg font-medium transition shadow-md"
                  style="background-color: white !important; color: #1e3a8a !important; border: 2px solid rgba(255,255,255,0.5) !important;">
                  📊 Generar P&L Report
                </button>
              </div>

              <!-- 🏢 Reporte por Compañías -->
              <div class="card-section p-4 rounded-lg"
                style="background: linear-gradient(135deg, rgba(88,28,135,0.8) 0%, rgba(168,85,247,0.6) 100%);">
                <!-- Header -->
                <div class="border-b border-white/20 pb-3 mb-3">
                  <h3 class="text-lg font-bold" style="color: white !important;">
                    🏢 Reporte por Compañías
                  </h3>
                </div>
                <!-- Description -->
                <div class="mb-4">
                  <p class="text-sm mb-2" style="color: rgba(255,255,255,0.85) !important;">
                    Análisis detallado de ingresos, cargas y RPM por cada compañía.
                  </p>
                  <div class="text-xs" style="color: rgba(255,255,255,0.6) !important;">
                    ✅ Ingresos por Compañía<br>
                    ✅ Top 3 Mejores<br>
                    ✅ RPM Promedio<br>
                    ✅ Total de Cargas
                  </div>
                </div>
                <!-- Button -->
                <button onclick="generateCompanyReport()"
                  class="w-full px-4 py-2 rounded-lg font-medium transition shadow-md"
                  style="background-color: white !important; color: #581c87 !important; border: 2px solid rgba(255,255,255,0.5) !important;">
                  🏢 Analizar Compañías
                </button>
              </div>

              <!-- 📈 Desglose de Gastos -->
              <div class="card-section p-4 rounded-lg"
                style="background: linear-gradient(135deg, rgba(194,65,12,0.8) 0%, rgba(249,115,22,0.6) 100%);">
                <!-- Header -->
                <div class="border-b border-white/20 pb-3 mb-3">
                  <h3 class="text-lg font-bold" style="color: white !important;">
                    📈 Desglose de Gastos
                  </h3>
                </div>
                <!-- Description -->
                <div class="mb-4">
                  <p class="text-sm mb-2" style="color: rgba(255,255,255,0.85) !important;">
                    Análisis completo de gastos por categoría con visualización.
                  </p>
                  <div class="text-xs" style="color: rgba(255,255,255,0.6) !important;">
                    ✅ Gastos por Categoría<br>
                    ✅ Top 3 Categorías<br>
                    ✅ % del Total<br>
                    ✅ Gráfico Visual
                  </div>
                </div>
                <!-- Button -->
                <button onclick="generateExpenseBreakdownReport()"
                  class="w-full px-4 py-2 rounded-lg font-medium transition shadow-md"
                  style="background-color: white !important; color: #c2410c !important; border: 2px solid rgba(255,255,255,0.5) !important;">
                  📈 Ver Desglose
                </button>
              </div>

              <!-- 🗺️ Rentabilidad por Zona -->
              <div class="card-section p-4 rounded-lg"
                style="background: linear-gradient(135deg, rgba(22,101,52,0.8) 0%, rgba(34,197,94,0.6) 100%);">
                <!-- Header -->
                <div class="border-b border-white/20 pb-3 mb-3">
                  <h3 class="text-lg font-bold" style="color: white !important;">
                    🗺️ Rentabilidad por Zona
                  </h3>
                </div>
                <!-- Description -->
                <div class="mb-4">
                  <p class="text-sm mb-2" style="color: rgba(255,255,255,0.85) !important;">
                    Identifica las rutas más y menos rentables por RPM.
                  </p>
                  <div class="text-xs" style="color: rgba(255,255,255,0.6) !important;">
                    ✅ Top 5 Mejores Rutas<br>
                    ✅ Top 5 Peores Rutas<br>
                    ✅ RPM por Ruta<br>
                    ✅ Recomendaciones
                  </div>
                </div>
                <!-- Button -->
                <button onclick="generateProfitabilityReport()"
                  class="w-full px-4 py-2 rounded-lg font-medium transition shadow-md"
                  style="background-color: white !important; color: #166534 !important; border: 2px solid rgba(255,255,255,0.5) !important;">
                  🗺️ Analizar Zonas
                </button>
              </div>

            </div>

            <!-- Modal para Reportes Financieros -->
            <div id="reportModal" class="hidden fixed inset-0 z-50"
              style="background-color: rgba(0,0,0,0.85); backdrop-filter: blur(10px);"
              onclick="if(event.target.id==='reportModal') closeReportModal()">
              <div class="flex flex-col h-full">

                <!-- Header del Modal (Fijo) -->
                <div id="reportModalHeader"
                  class="flex-shrink-0 bg-gradient-to-r from-blue-700 to-blue-900 text-white p-4 flex justify-between items-center shadow-lg">
                  <div class="flex items-center gap-3">
                    <span class="text-2xl" id="reportModalIcon">📊</span>
                    <div>
                      <h2 class="text-lg font-bold" id="reportModalTitle">Reporte Financiero</h2>
                      <p class="text-xs text-white/70" id="reportModalSubtitle">Período: --</p>
                    </div>
                  </div>
                  <button onclick="closeReportModal()"
                    class="w-10 h-10 flex items-center justify-center rounded-full bg-white/20 hover:bg-white/30 text-xl transition">
                    ✕
                  </button>
                </div>

                <!-- Contenido del Reporte (Scrollable) -->
                <div id="reportContent" class="flex-1 overflow-y-auto overflow-x-hidden p-4 md:p-6"
                  style="min-height: 0; max-height: calc(100vh - 200px); padding-bottom: 60px;">
                  <!-- El contenido del reporte se inyecta aquí dinámicamente -->
                  <div class="text-center py-12 text-gray-500">
                    <span class="text-4xl block mb-3">📋</span>
                    <p>Generando reporte...</p>
                  </div>
                </div>

                <!-- Footer del Modal (Fijo) -->
                <div class="flex-shrink-0 bg-white border-t p-3 flex flex-wrap justify-center gap-2">
                  <button onclick="printReport()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition">
                    🖨️ Imprimir / PDF
                  </button>
                  <button onclick="exportReportToPDF()"
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition">
                    📥 Exportar PDF (beta)
                  </button>
                  <button onclick="closeReportModal()"
                    class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition"
                    style="color: #374151 !important; -webkit-text-fill-color: #374151 !important;">
                    ❌ Cerrar
                  </button>
                </div>

              </div>
            </div>

          </div>

          <!-- 💵 Contenido CUENTAS -->
          <div id="finances-accounts" class="fin-subcontent hidden space-y-6">

            <!-- ✅ Selector Unificado (Cuentas) -->
            <div class="card-section">
              <div class="grid grid-cols-2 md:flex md:flex-row gap-4 items-start md:items-center">
                <!-- Año -->
                <div class="flex items-center gap-2">
                  <label for="accountsYear" class="text-sm font-medium text-gray-700 hidden md:inline">Año</label>
                  <select id="accountsYear" class="border border-gray-300 rounded px-3 py-2 w-32"></select>
                </div>

                <!-- Mes -->
                <div class="flex items-center gap-2">
                  <label for="accountsMonth" class="text-sm font-medium text-gray-700 hidden md:inline">Mes</label>
                  <select id="accountsMonth" class="border border-gray-300 rounded px-3 py-2 w-40"></select>
                </div>



                <!-- Estado -->
                <div class="flex items-center gap-2">
                  <label for="accountsStatus" class="text-sm font-medium text-gray-700 hidden md:inline">Estado</label>
                  <select id="accountsStatus" class="border border-gray-300 rounded px-3 py-2 w-32">
                    <option value="">Todos</option>
                    <option value="pending">Pendientes</option>
                    <option value="overdue">Vencidas</option>
                    <option value="paid">Pagadas</option>
                  </select>
                </div>

                <!-- Ordenamiento -->
                <div class="flex items-center gap-2">
                  <label for="accountsSort" class="text-sm font-medium text-gray-700 hidden md:inline">Ordenar</label>
                  <select id="accountsSort" class="border border-gray-300 rounded px-3 py-2 w-32 md:w-40">
                    <option value="date-desc">Reciente</option>
                    <option value="date-asc">Fecha</option>
                    <option value="amount-desc">Mayor</option>
                    <option value="amount-asc">Menor</option>
                    <option value="company"> A-Z</option>
                    <option value="overdue">Vencidas</option>
                  </select>
                </div>
                <!-- Botón Actualizar -->
                <button
                  class="col-span-2 md:col-span-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm font-medium"
                  onclick="applyPeriod('accounts')">
                  Actualizar
                </button>
              </div>
            </div>

            <!-- 📊 Tarjetas de Resumen -->
            <div id="accountsSummaryCards" class="mt-6">
              <!-- Las tarjetas se generarán aquí dinámicamente -->
            </div>

            <div id="accountsList" class="space-y-6">
              <!-- El dashboard se inserta aquí -->
            </div>

          </div>
        </div>
      </section>

      <!-- ✅ MODAL PARA AGREGAR GASTOS -->
      <div id="expenseModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">

          <!-- Modal Header -->
          <div class="border-b border-gray-200 px-6 py-4 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">➕ Agregar Gasto</h3>
            <button type="button" onclick="closeExpenseModal()" class="text-gray-400 hover:text-gray-600">
              <span class="text-2xl">&times;</span>
            </button>
          </div>

          <!-- Modal Body -->
          <div class="px-6 py-4">
            <div class="space-y-4">

              <!-- Fecha -->
              <div>
                <label for="expenseDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                <input type="date" id="expenseDate" name="expenseDate"
                  class="border border-gray-300 rounded px-3 py-2 w-full focus:border-blue-500 focus:outline-none"
                  required>
              </div>

              <!-- Categoría -->
              <div>
                <label for="expenseType" class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                <select id="expenseType" name="expenseType"
                  class="border border-gray-300 rounded px-3 py-2 w-full focus:border-blue-500 focus:outline-none"
                  required>
                  <option value="">Seleccione una categoría</option>
                  <option value="fuel">🚚 Combustible</option>
                  <option value="maintenance">🔧 Mantenimiento</option>
                  <option value="food">🍔 Comida</option>
                  <option value="lodging">🏨 Hospedaje</option>
                  <option value="tolls">🛣️ Peajes</option>
                  <option value="insurance">🛡️ Seguro</option>
                  <option value="permits">📋 Permisos</option>
                  <option value="carpayment">🚗 Pago de Auto</option>
                  <option value="other">📦 Otros</option>
                </select>
              </div>

              <!-- Monto -->
              <div>
                <label for="expenseAmount" class="block text-sm font-medium text-gray-700 mb-1">Monto ($)</label>
                <input type="number" id="expenseAmount" name="expenseAmount" placeholder="0.00" step="0.01" min="0"
                  class="border border-gray-300 rounded px-3 py-2 w-full focus:border-blue-500 focus:outline-none"
                  required>
              </div>

              <!-- Descripción -->
              <div>
                <label for="expenseDescription" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                <input type="text" id="expenseDescription" name="expenseDescription" placeholder="Descripción del gasto"
                  class="border border-gray-300 rounded px-3 py-2 w-full focus:border-blue-500 focus:outline-none">
              </div>

              <!-- Deducible -->
              <div class="flex items-center">
                <input type="checkbox" id="expenseDeductible" name="expenseDeductible" class="mr-2">
                <label for="expenseDeductible" class="text-sm text-gray-600">Este gasto es deducible</label>
              </div>

            </div>
          </div>

          <!-- Modal Footer -->
          <div class="border-t border-gray-200 px-6 py-4 flex flex-col sm:flex-row gap-3 sm:justify-end">
            <button type="button" onclick="closeExpenseModal()"
              class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 order-2 sm:order-1">
              Cancelar
            </button>
            <button type="button" onclick="saveExpenseToFirebase()"
              class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 order-1 sm:order-2">
              💾 Guardar Gasto
            </button>
          </div>

        </div>
      </div>


      <!-- Zones Tab -->
      <section id="zones" class="tab-content hidden">
        <div class="w-full px-3 md:px-6 py-4 md:py-6 space-y-4 md:space-y-8">
          <div class="section-header text-center">
            <h2 class="font-bold mb-4">🗺️ Zonas / Heatmap</h2>
            <p class="subtitle">Analiza la rentabilidad por estado con mapa interactivo</p>
          </div>

          <!-- Map placeholder -->
          <div class="flex flex-col lg:flex-row gap-10">
            <div class="flex-1 bg-gray-100 border rounded p-8 text-center">
              <object id="interactiveMap" data="usa_states_ids_fixed_by_title.svg" type="image/svg+xml"
                class="w-full h-80">
                <p class="text-gray-600">🗺️ Mapa SVG no disponible</p>
              </object>
            </div>

            <div class="w-full lg:w-[300px] bg-gray-50 border border-gray-200 rounded-lg shadow p-4">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">ℹ️ Información del Estado</h3>
              <div class="text-center text-gray-500">
                <p class="text-sm">Pasa el cursor sobre un estado</p>
              </div>
            </div>
          </div>

          <!-- Legend -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="flex items-center p-3 bg-red-50 border border-red-200 rounded-lg">
              <div class="w-4 h-4 bg-red-600 rounded-full mr-3"></div>
              <div>
                <p class="font-medium text-red-800">Zona roja</p>
                <p class="text-sm text-red-600">Menor a $0.75 RPM</p>
              </div>
            </div>
            <div class="flex items-center p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
              <div class="w-4 h-4 bg-yellow-400 rounded-full mr-3"></div>
              <div>
                <p class="font-medium text-yellow-800">Zona amarilla</p>
                <p class="text-sm text-yellow-600">Entre $0.75 – $1.05 RPM</p>
              </div>
            </div>
            <div class="flex items-center p-3 bg-green-50 border border-green-200 rounded-lg">
              <div class="w-4 h-4 bg-green-600 rounded-full mr-3"></div>
              <div>
                <p class="font-medium text-green-800">Zona verde</p>
                <p class="text-sm text-green-600">Mayor a $1.05 RPM</p>
              </div>
            </div>
          </div>

          <!-- Zones table -->
          <div class="card-section">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-2 mb-4">
              <h3 class="text-lg font-semibold">📍 Tabla de zonas por estado</h3>
              <button onclick="printZonesReport()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition w-full md:w-auto justify-center">
                📊 Imprimir Reporte
              </button>
            </div>
            <!-- Contenedor con altura máxima y scroll (responsive) -->
            <div class="overflow-x-auto overflow-y-auto border border-gray-300 rounded-lg" style="max-height: 400px;">
              <table class="min-w-full text-xs md:text-sm">
                <thead class="bg-gray-200 md:sticky md:top-0 z-10">
                  <tr>
                    <th class="p-2 text-left cursor-pointer" onclick="sortZonesBy('state')">Estado</th>
                    <th class="p-2 text-left">Zona</th>
                    <th class="p-2 text-left cursor-pointer" onclick="sortZonesBy('count')">Cargas</th>
                    <th class="p-2 text-left cursor-pointer" onclick="sortZonesBy('rpm')">RPM Promedio</th>
                    <th class="p-2 text-left cursor-pointer" onclick="sortZonesBy('totalProfit')">Ganancia Total</th>
                    <th class="p-2 text-left">Rendimiento</th>
                  </tr>
                </thead>
                <tbody id="zoneDataBody">
                  <tr>
                    <td colspan="6" class="p-4 text-center text-gray-500">
                      Sin datos disponibles. ¡Crea algunas cargas para ver el análisis de zonas!
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- 🆕 MAPA DE CIUDADES CON GOOGLE MAPS -->
          <div class="card-section mt-8">
            <h3 class="text-lg font-semibold mb-4">🌎 Mapa de Ciudades de Destino</h3>
            <p class="text-sm text-gray-600 mb-4">Visualiza todas las ciudades donde has entregado cargas, con
              marcadores de color según RPM</p>

            <!-- Contenedor del mapa -->
            <div id="citiesMapContainer" class="mb-4">
              <div id="citiesMap" class="w-full h-96 rounded-lg border-2 border-gray-300 bg-gray-100"></div>
            </div>

            <!-- Leyenda del mapa de ciudades -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div class="flex items-center p-3 bg-green-50 border border-green-200 rounded-lg">
                <div class="w-4 h-4 bg-green-600 rounded-full mr-3"></div>
                <div>
                  <p class="font-medium text-green-800">Alta rentabilidad</p>
                  <p class="text-sm text-green-600">RPM > $1.05</p>
                </div>
              </div>
              <div class="flex items-center p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="w-4 h-4 bg-yellow-500 rounded-full mr-3"></div>
                <div>
                  <p class="font-medium text-yellow-800">Rentabilidad media</p>
                  <p class="text-sm text-yellow-600">$0.75 - $1.05 RPM</p>
                </div>
              </div>
              <div class="flex items-center p-3 bg-red-50 border border-red-200 rounded-lg">
                <div class="w-4 h-4 bg-red-600 rounded-full mr-3"></div>
                <div>
                  <p class="font-medium text-red-800">Baja rentabilidad</p>
                  <p class="text-sm text-red-600">RPM < $0.75</p>
                </div>
              </div>
            </div>

            <!-- Tabla de top ciudades -->
            <div>
              <h4 class="text-md font-semibold mb-2">🧮 Top Ciudades por Cargas</h4>
              <!-- Contenedor con altura máxima y scroll (responsive) -->
              <div class="overflow-x-auto overflow-y-auto border border-gray-300 rounded-lg" style="max-height: 350px;">
                <table class="min-w-full text-xs md:text-sm">
                  <thead class="bg-gray-200 md:sticky md:top-0 z-10">
                    <tr>
                      <th class="p-2 text-left">#</th>
                      <th class="p-2 text-left">Ciudad</th>
                      <th class="p-2 text-left">Cargas</th>
                      <th class="p-2 text-left">RPM Promedio</th>
                      <th class="p-2 text-left">Ganancia Total</th>
                    </tr>
                  </thead>
                  <tbody id="citiesTableBody">
                    <tr>
                      <td colspan="4" class="p-4 text-center text-gray-500">
                        Cargando datos de ciudades...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- Settings Tab -->
      <section id="settings" class="tab-content hidden">
        <div class="w-full px-3 md:px-6 py-4 md:py-6 space-y-4 md:space-y-8">
          <div class="section-header text-center">
            <h2 class="font-bold mb-4">⚙️ Configuración de Tu Negocio</h2>
            <p class="subtitle">Personaliza la app según tu tipo de operación y costos reales</p>

            <!-- Mensaje de confirmación -->
            <div id="configMessage" class="config-message" style="display: none;"></div>

            <!-- 👑 ADMIN PANEL BUTTON (only shows for admin users) -->
            <div id="adminPanelSection" class="hidden mt-3 md:mt-6">
              <div class="bg-gradient-to-r from-purple-700 to-blue-700 rounded-lg p-2 md:p-6 text-left">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-2 md:gap-4">
                  <div>
                    <h3 class="text-white font-bold text-sm md:text-lg mb-0.5">👑 Admin Panel</h3>
                    <p class="text-purple-100 text-xs md:text-sm">Gestiona usuarios y sistema</p>
                  </div>
                  <button onclick="showAdminPanel()"
                    class="bg-white text-purple-600 font-semibold px-3 py-1.5 md:px-6 md:py-3 rounded-lg hover:bg-gray-100 transition text-xs md:text-base w-full md:w-auto">
                    Abrir
                  </button>
                </div>
              </div>
            </div>
            <script>
              // Show admin section only for admin users
              document.addEventListener('DOMContentLoaded', function () {
                setTimeout(async function () {
                  try {
                    const user = firebase.auth().currentUser;
                    if (!user) return;
                    const doc = await firebase.firestore().collection('users').doc(user.uid).get();
                    if (doc.exists && (doc.data().plan === 'admin' || doc.data().role === 'admin')) {
                      document.getElementById('adminPanelSection').classList.remove('hidden');
                    }
                  } catch (e) { console.log('Admin check:', e); }
                }, 2000);
              });
            </script>
            <!-- 1. PERFIL DE OPERACION -->
            <div class="card-section">
              <h3 class="text-lg font-semibold mb-4">🚛 Perfil de Operación</h3>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                  <label for="vehicleType" class="block text-sm font-medium text-gray-700 mb-2">
                    Tipo de Vehículo
                  </label>
                  <select id="vehicleType" name="vehicleType" onchange="loadVehicleTemplate(this.value)"
                    class="border p-3 w-full rounded-lg">
                    <option value="van">Van/Sprinter</option>
                    <option value="boxtruck">Box Truck</option>
                    <option value="semi">Semi Trailer</option>
                    <option value="hotshot">Hotshot Pickup</option>
                    <option value="custom">Otro (Personalizado)</option>
                  </select>
                  <input type="text" id="customVehicleType" name="customVehicleType"
                    placeholder="Ingresa tipo de vehículo" class="hidden border p-3 w-full rounded-lg mt-2" />
                  <p class="text-xs text-gray-500 mt-1">Carga plantilla de costos típicos</p>
                </div>

                <div>
                  <label for="businessName" class="block text-sm font-medium text-gray-700 mb-2">
                    Nombre del Negocio
                  </label>
                  <input type="text" id="businessName" name="businessName" placeholder="Tu empresa LLC"
                    class="border p-3 w-full rounded-lg">
                </div>

                <div>
                  <label for="operatingState" class="block text-sm font-medium text-gray-700 mb-2">
                    Estado Base
                  </label>
                  <select id="operatingState" name="operatingState" class="border p-3 w-full rounded-lg"
                    onchange="toggleCustomStateInput()">
                    <option value="FL">Florida</option>
                    <option value="TX">Texas</option>
                    <option value="CA">California</option>
                    <option value="NY">New York</option>
                    <option value="other">Otro</option>
                  </select>
                  <input type="text" id="customState" name="customState" placeholder="Ingresa tu estado"
                    class="hidden border p-3 w-full rounded-lg mt-2" />
                </div>
              </div>
            </div>

            <!-- 2. COSTOS FIJOS MENSUALES -->
            <div class="card-section">
              <h3 class="text-lg font-semibold mb-4">💰 Costos Fijos Mensuales</h3>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                  <div>
                    <label for="vehiclePayment" class="block text-sm font-medium text-gray-700 mb-2">
                      Pago del Vehículo
                    </label>
                    <input type="number" id="vehiclePayment" name="vehiclePayment" step="1" value="800"
                      oninput="calculateTotals()" class="border p-3 w-full rounded-lg">
                  </div>

                  <div>
                    <label for="insurance" class="block text-sm font-medium text-gray-700 mb-2">
                      Seguro Mensual
                    </label>
                    <input type="number" id="insurance" name="insurance" step="1" value="1250"
                      oninput="calculateTotals()" class="border p-3 w-full rounded-lg">
                  </div>

                  <div>
                    <label for="licenses" class="block text-sm font-medium text-gray-700 mb-2">
                      Licencias/Permisos
                    </label>
                    <input type="number" id="licenses" name="licenses" step="1" value="150" oninput="calculateTotals()"
                      class="border p-3 w-full rounded-lg">
                  </div>

                  <div>
                    <label for="otherFixed" class="block text-sm font-medium text-gray-700 mb-2">
                      Otros Gastos Fijos
                    </label>
                    <input type="number" id="otherFixed" name="otherFixed" step="1" value="200"
                      oninput="calculateTotals()" class="border p-3 w-full rounded-lg">
                    <p class="text-xs text-gray-500 mt-1">Teléfono, internet, etc.</p>
                  </div>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                  <h4 class="font-semibold text-blue-800 mb-3">🧮 Resumen Automático</h4>

                  <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                      <span>Total Fijo Mensual:</span>
                      <span id="totalFixed" class="font-bold">$2,400</span>
                    </div>

                    <div class="flex justify-between">
                      <span>Costo Fijo por Milla:</span>
                      <span id="fixedCostPerMile" class="font-bold text-blue-600">$0.300</span>
                    </div>

                    <div class="text-xs text-blue-600 mt-2">
                      * Basado en tus millas mensuales objetivo
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 3. COSTOS VARIABLES POR MILLA -->
            <div class="card-section">
              <h3 class="text-lg font-semibold mb-4"> Costos Variables por Milla</h3>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                  <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <h4 class="font-semibold text-yellow-800 mb-2">Combustible</h4>

                    <div class="grid grid-cols-2 gap-3">
                      <div>
                        <label for="fuelMPG" class="block text-xs font-medium text-gray-700 mb-1">
                          MPG de tu vehículo
                        </label>
                        <input type="number" id="fuelMPG" name="fuelMPG" step="0.1" value="18"
                          oninput="calculateFuelCost()" class="border p-2 w-full rounded text-sm">
                      </div>

                      <div>
                        <label for="fuelPricePerGallon" class="block text-xs font-medium text-gray-700 mb-1">
                          Precio por galón
                        </label>
                        <input type="number" id="fuelPricePerGallon" name="fuelPricePerGallon" step="0.01" value="3.50"
                          oninput="calculateFuelCost()" class="border p-2 w-full rounded text-sm">
                      </div>
                    </div>

                    <div class="mt-2 text-center">
                      <span class="text-xs text-yellow-700">Costo calculado: </span>
                      <span id="calculatedFuelCost" class="font-bold text-yellow-800">$0.194/mi</span>
                    </div>
                  </div>

                  <div>
                    <label for="maintenancePerMile" class="block text-sm font-medium text-gray-700 mb-2">
                      Mantenimiento ($/milla)
                    </label>
                    <input type="number" id="maintenancePerMile" name="maintenancePerMile" step="0.001" value="0.080"
                      class="border p-3 w-full rounded-lg">
                    <details class="mt-2 bg-blue-50 border border-blue-200 rounded p-2">
                      <summary class="cursor-pointer text-sm font-medium text-blue-700">📊 Calculadora de Mantenimiento
                      </summary>
                      <div class="mt-2 space-y-2">
                        <input type="number" id="maintenanceServiceCost" placeholder="Costo por servicio ($)"
                          class="border p-2 w-full rounded text-sm">
                        <input type="number" id="maintenanceInterval" placeholder="Intervalo (millas)"
                          class="border p-2 w-full rounded text-sm">
                        <button onclick="calculateMaintenanceCost()"
                          class="bg-blue-600 text-white px-3 py-1 rounded text-sm w-full hover:bg-blue-700">Calcular
                          $/mi</button>
                      </div>
                    </details>
                    <p class="text-xs text-gray-500 mt-1">Cambios de aceite, filtros, etc.</p>
                  </div>

                  <div>
                    <label for="tiresPerMile" class="block text-sm font-medium text-gray-700 mb-2">
                      Llantas ($/milla)
                    </label>
                    <input type="number" id="tiresPerMile" name="tiresPerMile" step="0.001" value="0.060"
                      class="border p-3 w-full rounded-lg">
                    <details class="mt-2 bg-orange-50 border border-orange-200 rounded p-2">
                      <summary class="cursor-pointer text-sm font-medium text-orange-700">🛞 Calculadora de Llantas
                      </summary>
                      <div class="mt-2 space-y-2">
                        <input type="number" id="tireCost" placeholder="Costo del juego de llantas ($)"
                          class="border p-2 w-full rounded text-sm">
                        <input type="number" id="tireLifespan" placeholder="Vida útil (millas)"
                          class="border p-2 w-full rounded text-sm">
                        <button onclick="calculateTireCost()"
                          class="bg-orange-600 text-white px-3 py-1 rounded text-sm w-full hover:bg-orange-700">Calcular
                          $/mi</button>
                      </div>
                    </details>
                    <p class="text-xs text-gray-500 mt-1">Promedio de vida útil</p>
                  </div>

                  <div>
                    <label for="repairsPerMile" class="block text-sm font-medium text-gray-700 mb-2">
                      Reparaciones ($/milla)
                    </label>
                    <input type="number" id="repairsPerMile" name="repairsPerMile" step="0.001" value="0.040"
                      class="border p-3 w-full rounded-lg">
                    <details class="mt-2 bg-red-50 border border-red-200 rounded p-2">
                      <summary class="cursor-pointer text-sm font-medium text-red-700">🔧 Calculadora de Reparaciones
                      </summary>
                      <div class="mt-2 space-y-2">
                        <select id="repairPeriod" class="border p-2 w-full rounded text-sm">
                          <option value="monthly">Reserva Mensual</option>
                          <option value="annual">Reserva Anual</option>
                        </select>
                        <input type="number" id="repairReserve" placeholder="Monto de reserva ($)"
                          class="border p-2 w-full rounded text-sm">
                        <button onclick="calculateRepairCost()"
                          class="bg-red-600 text-white px-3 py-1 rounded text-sm w-full hover:bg-red-700">Calcular
                          $/mi</button>
                      </div>
                    </details>
                    <p class="text-xs text-gray-500 mt-1">Emergencias y averías</p>
                  </div>
                </div>

                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                  <h4 class="font-semibold text-green-800 mb-3">🎯 Configuración de Costos</h4>

                  <div class="space-y-3">
                    <div class="flex items-center">
                      <input type="checkbox" id="useRealCosts" name="useRealCosts" checked class="mr-3">
                      <label for="useRealCosts" class="text-sm font-medium text-gray-700">
                        Usar costos reales calculados
                      </label>
                    </div>

                    <div>
                      <label for="realCostsPeriod" class="block text-sm font-medium text-gray-700 mb-2">
                        Período para cálculo automático
                      </label>
                      <select id="realCostsPeriod" name="realCostsPeriod" class="border p-2 w-full rounded text-sm">
                        <option value="1">Ultimo mes</option>
                        <option value="3" selected>Ultimos 3 meses</option>
                        <option value="6">Ultimos 6 meses</option>
                        <option value="12">Ultimo año</option>
                      </select>
                    </div>

                    <div class="text-xs text-green-600 mt-2">
                      Cuando está activado, la app calcula tus costos reales basados en tus viajes y gastos registrados.
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 4. METAS DE NEGOCIO -->
            <div class="card-section">
              <h3 class="text-lg font-semibold mb-4">🎯 Metas de Negocio</h3>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                  <label for="targetRPM" class="block text-sm font-medium text-gray-700 mb-2">
                    RPM Mínimo Objetivo
                  </label>
                  <input type="number" id="targetRPM" name="targetRPM" step="0.01" value="1.25"
                    class="border p-3 w-full rounded-lg">
                  <p class="text-xs text-gray-500 mt-1">Tarifa mínima que aceptas</p>
                </div>

                <div>
                  <label for="monthlyMilesGoal" class="block text-sm font-medium text-gray-700 mb-2">
                    Millas Mensuales Objetivo
                  </label>
                  <input type="number" id="monthlyMilesGoal" name="monthlyMilesGoal" step="100" value="8000"
                    oninput="calculateTotals()" class="border p-3 w-full rounded-lg">
                  <p class="text-xs text-gray-500 mt-1">Meta de millas por mes</p>
                </div>

                <div>
                  <label for="targetProfit" class="block text-sm font-medium text-gray-700 mb-2">
                    Margen de Ganancia (%)
                  </label>
                  <input type="number" id="targetProfit" name="targetProfit" step="1" value="30" min="0" max="100"
                    class="border p-3 w-full rounded-lg">
                  <p class="text-xs text-gray-500 mt-1">Ganancia neta objetivo</p>
                </div>
              </div>
            </div>

            <!-- 5. BOTONES DE ACCIÃ“N -->
            <div class="card-section">
              <div class="flex flex-col md:flex-row gap-4 justify-center">
                <button onclick="saveUserConfiguration()"
                  class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                  💾 Guardar Configuración
                </button>

                <button onclick="loadUserConfiguration()"
                  class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 font-semibold">
                  🔄 Recargar Guardada
                </button>

                <button onclick="loadVehicleTemplate(document.getElementById('vehicleType').value)"
                  class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-semibold">
                  🚛 Aplicar Plantilla
                </button>
              </div>

              <div class="text-center mt-4">
                <p class="text-sm text-gray-600">
                  Tu configuración se guarda automáticamente y se sincroniza entre dispositivos
                </p>
              </div>
            </div>
          </div>
      </section>
    </main>

    <!-- ✅ Month Picker Modal - Custom para móvil -->
    <div id="monthPickerModal" class="hidden fixed inset-0 z-50"
      style="background-color: rgba(0,0,0,0.8); backdrop-filter: blur(8px);"
      onclick="if(event.target.id==='monthPickerModal') closeMonthPicker()">
      <div class="flex flex-col h-full md:items-center md:justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full md:max-w-md overflow-hidden my-auto"
          style="max-height: 90vh;" onclick="event.stopPropagation()">

          <!-- Header -->
          <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-4 flex justify-between items-center">
            <h3 class="text-lg font-bold flex items-center gap-2">
              📅 Seleccionar Mes
            </h3>
            <button onclick="closeMonthPicker()"
              class="w-8 h-8 flex items-center justify-center rounded-full bg-white/20 hover:bg-white/30 text-xl">&times;</button>
          </div>

          <!-- Month Grid -->
          <div id="monthPickerGrid" class="p-4 overflow-y-auto" style="max-height: 60vh;">
            <div class="grid grid-cols-1 gap-2" id="monthButtonsContainer">
              <!-- Los meses se generarán dinámicamente -->
              <div class="text-center text-gray-500 py-4">Cargando meses...</div>
            </div>
          </div>

          <!-- Footer con botón Cancelar -->
          <div class="border-t p-4" style="background-color: #f8fafc;">
            <button onclick="closeMonthPicker()" class="w-full py-3 font-semibold rounded-xl transition"
              style="background-color: #e5e7eb !important; color: #374151 !important; -webkit-text-fill-color: #374151 !important;">
              ❌ Cancelar
            </button>
          </div>

          <!-- CSS Override for month buttons -->
          <style>
            #monthButtonsContainer button {
              color: white !important;
              background-color: rgba(30, 58, 138, 0.7) !important;
              border: 2px solid rgba(96, 165, 250, 0.4) !important;
            }

            #monthButtonsContainer button:first-child {
              background: linear-gradient(to right, #3b82f6, #2563eb) !important;
            }
          </style>
        </div>
      </div>
    </div>

    <!-- ✅ Edit Modal -->
    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
      <!-- Modal principal limitado al 90% de la pantalla -->
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">

        <!-- Header fijo -->
        <div class="border-b border-gray-200 px-6 py-4 flex items-center justify-between flex-none">
          <h3 class="text-lg font-semibold text-gray-900">✏️ Editar Carga</h3>
          <button type="button" onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
            <span class="text-2xl">&times;</span>
          </button>
        </div>

        <!-- Body con scroll interno -->
        <div class="px-6 py-4 overflow-y-auto flex-1" style="max-height:65vh;">
          <div class="space-y-4">

            <!-- Información básica -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="editDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                <input type="date" id="editDate" name="editDate"
                  class="border border-gray-300 rounded px-3 py-2 w-full focus:border-blue-500 focus:outline-none"
                  required>
              </div>
              <div>
                <label for="editLoadNumber" class="block text-sm font-medium text-gray-700 mb-1">Número de Carga</label>
                <input type="text" id="editLoadNumber" name="editLoadNumber" placeholder="Número de carga"
                  class="border border-gray-300 rounded px-3 py-2 w-full focus:border-blue-500 focus:outline-none">
              </div>
            </div>

            <!-- Origen y Destino -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="editOrigin" class="block text-sm font-medium text-gray-700 mb-1">Origen *</label>
                <input type="text" id="editOrigin" name="editOrigin" placeholder="Miami, FL"
                  class="border border-gray-300 rounded px-3 py-2 w-full focus:border-blue-500 focus:outline-none"
                  required>
              </div>
              <div>
                <label for="editDestination" class="block text-sm font-medium text-gray-700 mb-1">Destino *</label>
                <input type="text" id="editDestination" name="editDestination" placeholder="Atlanta, GA"
                  class="border border-gray-300 rounded px-3 py-2 w-full focus:border-blue-500 focus:outline-none"
                  required>
              </div>
            </div>

            <!-- Millas -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label for="editLoadedMiles" class="block text-sm font-medium text-gray-700 mb-1">Millas Cargadas
                  *</label>
                <input type="number" id="editLoadedMiles" name="editLoadedMiles" placeholder="600" min="0" required
                  class="border border-gray-300 rounded px-3 py-2 w-full focus:border-blue-500 focus:outline-none">
              </div>
              <div>
                <label for="editDeadheadMiles" class="block text-sm font-medium text-gray-700 mb-1">Millas
                  Vacías</label>
                <input type="number" id="editDeadheadMiles" name="editDeadheadMiles" placeholder="25" min="0"
                  class="border border-gray-300 rounded px-3 py-2 w-full focus:border-blue-500 focus:outline-none">
              </div>
              <div>
                <label for="editTotalMiles" class="block text-sm font-medium text-gray-700 mb-1">Total Millas</label>
                <input type="number" id="editTotalMiles" name="editTotalMiles" readonly
                  class="border border-gray-200 rounded px-3 py-2 w-full bg-gray-50 text-gray-600">
              </div>
            </div>

            <!-- Información financiera -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="editRpm" class="block text-sm font-medium text-gray-700 mb-1">RPM ($/milla) *</label>
                <input type="number" id="editRpm" name="editRpm" placeholder="1.25" step="0.01" min="0" required
                  class="border border-gray-300 rounded px-3 py-2 w-full focus:border-blue-500 focus:outline-none">
              </div>
              <div>
                <label for="editTotalCharge" class="block text-sm font-medium text-gray-700 mb-1">Total a Cobrar</label>
                <input type="number" id="editTotalCharge" name="editTotalCharge" step="0.01" min="0"
                  class="border border-gray-300 rounded px-3 py-2 w-full focus:border-blue-500 focus:outline-none">
              </div>
            </div>

            <!-- Costos adicionales -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="editTolls" class="block text-sm font-medium text-gray-700 mb-1">Peajes ($)</label>
                <input type="number" id="editTolls" name="editTolls" placeholder="25.00" step="0.01" min="0"
                  class="border border-gray-300 rounded px-3 py-2 w-full focus:border-blue-500 focus:outline-none">
              </div>
              <div>
                <label for="editOtherCosts" class="block text-sm font-medium text-gray-700 mb-1">Otros Costos
                  ($)</label>
                <input type="number" id="editOtherCosts" name="editOtherCosts" placeholder="15.00" step="0.01" min="0"
                  class="border border-gray-300 rounded px-3 py-2 w-full focus:border-blue-500 focus:outline-none">
              </div>
              <div>
                <label for="editRepositionMiles" class="block text-sm font-medium text-gray-700">Reposicionamiento
                  (millas)</label>
                <input type="number" id="editRepositionMiles" class="border p-2 w-full rounded" placeholder="Ej: 120">
              </div>
            </div>

            <!-- Empresa y notas -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="editCompanyName" class="block text-sm font-medium text-gray-700 mb-1">Empresa</label>
                <input type="text" id="editCompanyName" name="editCompanyName" placeholder="Nombre de la empresa"
                  class="border border-gray-300 rounded px-3 py-2 w-full focus:border-blue-500 focus:outline-none">
              </div>
              <div class="md:col-span-2">
                <label for="editNotes" class="block text-sm font-medium text-gray-700 mb-1">Notas de experiencia</label>
                <textarea id="editNotes" name="editNotes" placeholder="Ej: RPM bajo, mejor relocalizar a Nashville"
                  rows="3"
                  class="border border-gray-300 rounded px-3 py-2 w-full focus:border-blue-500 focus:outline-none"></textarea>
              </div>
            </div>

            <!-- Resultados calculados -->
            <div class="border-t border-gray-200 pt-4">
              <h4 class="text-md font-medium text-gray-900 mb-3">🧮 Cálculos Automáticos</h4>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div class="bg-gray-50 p-2 rounded">
                  <span class="text-gray-600">Costo Operativo:</span>
                  <div id="editOperatingCost" class="font-semibold text-red-600">$0.00</div>
                </div>
                <div class="bg-gray-50 p-2 rounded">
                  <span class="text-gray-600">Costo Combustible:</span>
                  <div id="editFuelCost" class="font-semibold text-red-600">$0.00</div>
                </div>
                <div class="bg-gray-50 p-2 rounded">
                  <span class="text-gray-600">Ganancia Neta:</span>
                  <div id="editNetProfit" class="font-semibold text-green-600">$0.00</div>
                </div>
                <div class="bg-gray-50 p-2 rounded">
                  <span class="text-gray-600">Margen:</span>
                  <div id="editProfitMargin" class="font-semibold text-blue-600">0%</div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- Footer fijo -->
        <div
          class="border-t border-gray-200 px-6 py-4 flex flex-col sm:flex-row gap-3 sm:justify-end bg-white flex-none">
          <button type="button" onclick="closeEditModal()"
            class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 order-2 sm:order-1">
            Cancelar
          </button>
          <button type="button" onclick="saveEditedLoad()"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 order-1 sm:order-2">
            💾 Guardar Cambios
          </button>
        </div>

      </div>
    </div>



    <!-- Firebase compat -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>

    <!-- Chart.js for dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <!-- ✅ GOOGLE MAPS SCRIPT CORREGIDO - SIN CALLBACK AUTOMÃTICO -->
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkEYDbxkjXJx5wNh_7wMdIqmklOMCIyHY&libraries=places&callback=initGoogleMaps&loading=async">
      </script>


    <!--  SCRIPT DE INICIALIZACIÓN DE GOOGLE MAPS -->
    <script src="js/google-maps-init.js?v=1.0.0"></script>


    <!-- Scripts de la aplicación EN ESTE ORDEN -->
    <!-- Scripts de la aplicación EN ESTE ORDEN -->

    <!-- New modules - Load first -->
    <!-- MOCK DATA for V2 testing - Comment out to use real Firebase -->
    <script src="js/mock-data.js"></script>

    <script src="js/security.js"></script>
    <script src="js/ui-feedback.js"></script>

    <!-- Existing scripts -->
    <script src="js/config.js"></script>
    <script src="js/helpers.js"></script>
    <script src="js/settings.js"></script>
    <script src="js/calculator.js?v=2.1.1"></script>

    <!-- 🎯 SEQUENTIAL DESTINATIONS - Google Maps Style -->
    <script src="js/sequential-destinations.js"></script>

    <!-- 🚀 Calculator Lazy Loading System (NEW) - Loads modules on demand -->
    <script src="js/calculator-lazy-loader.js?v=1.0.0"></script>

    <!-- 🎨 Image Optimizer - WebP fallback & lazy loading -->
    <script src="js/image-optimizer.js?v=1.0.0"></script>

    <!-- ✨ UI Enhancements - Animations & UX improvements -->
    <script src="js/ui-enhancements.js?v=1.0.0"></script>

    <!-- 📦 Service Worker Registration - Cache strategies -->
    <script src="js/sw-register.js?v=1.0.0"></script>

    <!-- 💳 Stripe Integration - Payments & Subscriptions -->
    <script src="js/stripe-config.js?v=1.0.0"></script>
    <script src="js/upgrade-modal.js?v=1.0.0"></script>

    <script src="js/userPlans.js"></script>
    <script src="js/history.js?v=2.0.1"></script>

    <!-- 💰 Finances modules - Load in order (refactored) -->
    <script src="js/finances-core.js?v=1.0.0"></script>
    <script src="js/finances-data.js?v=1.0.0"></script>
    <script src="js/finances.js?v=3.1.1"></script>
    <script src="js/finances-ui.js?v=1.0.0"></script>

    <!-- 🚀 Lazy Loading System (NEW) - Loads charts/reports/expenses on demand -->
    <script src="js/lazy-loader.js?v=1.0.0"></script>

    <!-- 🎯 Lazy Loading Override - Forces lazy for expenses/reports -->
    <script src="js/finances-lazy-override.js?v=1.0.0"></script>

    <script src="js/zones.js"></script>
    <script src="js/core/roles-manager.js?v=1.0.0"></script>
    <script src="js/admin-panel.js"></script>
    <script src="js/role-badge-display.js?v=1.0.0"></script>
    <script src="js/onboarding-manager.js?v=1.0.3"></script>
    <script src="js/main.js"></script>
    <script src="js/core/agent-base.js"></script>
    <script src="js/core/event-bus.js"></script>
    <script src="js/core/conversation-memory.js"></script>
    <script src="js/core/pronoun-resolver.js"></script>
    <script src="js/core/response-builders.js"></script>
    <script src="js/core/sentiment-analyzer.js"></script>
    <script src="js/core/insights-analyzer.js"></script>
    <script src="js/core/decisions-tracker.js"></script>
    <script src="js/core/pattern-learner.js"></script>
    <script src="js/core/lex-master.js"></script>
    <script src="js/lex-ai-brain.js"></script>
    <script src="js/core/lex-modals.js"></script>
    <script src="js/lex-learning.js"></script>
    <script src="js/lex.js"></script>
    <script src="js/lex-intents.js"></script>
    <script src="js/lex-router.js"></script>

    <!-- Agentes -->
    <script src="js/agents/calculator-agent.js"></script>
    <script src="js/agents/history-agent.js"></script>
    <script src="js/agents/zones-agent.js"></script>
    <script src="js/agents/finances-agent.js"></script>

    <!-- <script src="js/tabs.js"></script> REMOVED: tabs.js functionality merged into main.js -->
    <script src="js/mobile.js"></script>
    <script src="js/mobile-menu.js?v=1.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="js/zones-print.js"></script>

    <!-- 🔍 Modal de Notas -->
    <div id="notesModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl p-6">
        <!-- Header -->
        <div class="flex justify-between items-center mb-4">
          <h3 id="notesModalTitle" class="text-xl font-bold text-gray-800">Notas para DESTINO</h3>
          <button onclick="closeNotesModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>

        <!-- Lista de Notas -->
        <div id="notesListModal" class="space-y-3 max-h-60 overflow-y-auto">
          <p class="text-gray-500 text-sm">No hay notas registradas aún.</p>
        </div>

      </div>
    </div>

  </div>

  <!-- 🔹 Lex AI Assistant (avatar flotante) -->
  <div id="lexAssistant" class="fixed bottom-4 right-4 z-60 flex flex-col items-end gap-2 select-none">

    <!-- Globito de mensaje de Lex (encima del avatar) -->
    <div id="lexBubble"
      class="hidden max-w-xs text-xs rounded-2xl shadow-lg px-3 py-2 mb-2 bg-slate-900/95 border border-slate-700">
      <p id="lexBubbleText" class="font-medium text-slate-50">
        Hola, soy Lex. Te ayudaré con tus decisiones de carga. 👋
      </p>

      <div class="mt-2 flex items-center gap-2">
        <button id="lexQuickAnalyzeBtn" type="button" class="lex-action-btn lex-btn-analyze"
          onclick="window.triggerLex && window.triggerLex()">
          ⚡ Análisis
        </button>

        <button id="lexOpenChatBtn" type="button" class="lex-action-btn lex-btn-chat"
          onclick="window.openLexChatModal && window.openLexChatModal()">
          💬 Chat
        </button>
      </div>
    </div>



    <!-- Avatar -->
    <div class="relative">
      <div class="lex-avatar-shell w-16 h-16 rounded-full bg-gradient-to-br from-blue-600 to-purple-700 
                border border-blue-400 shadow-2xl flex items-center justify-center overflow-hidden">
        <img id="lexAvatarImg" src="img/lex/lex-neutral.png" alt="Lex AI Assistant"
          class="w-14 h-14 object-contain lex-avatar-img">
      </div>

      <!-- Puntico de estado -->
      <span id="lexStatusDot"
        class="absolute -bottom-1 -right-1 w-4 h-4 rounded-full border-2 border-slate-900 bg-emerald-400 shadow-lg">
      </span>
    </div>
  </div>

  <!-- Custom Categories Module -->
  <script src="js/custom-categories.js"></script>

  <!-- ✅ MODAL PARA GESTIONAR CATEGORÍAS -->
  <div id="categoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">

      <!-- Modal Header -->
      <div class="border-b border-gray-200 px-6 py-4 flex items-center justify-between sticky top-0 bg-white">
        <h3 class="text-lg font-semibold text-gray-900">⚙️ Gestión de Categorías de Gastos</h3>
        <button type="button" onclick="closeCategoryModal()" class="text-gray-400 hover:text-gray-600">
          <span class="text-2xl">&times;</span>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="px-6 py-4">

        <!-- Formulario de Nueva Categoría -->
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
          <h4 class="text-md font-semibold text-purple-900 mb-3">➕ Crear Nueva Categoría</h4>

          <div class="space-y-4">

            <!-- Nombre -->
            <div>
              <label for="categoryName" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la
                Categoría</label>
              <input type="text" id="categoryName" placeholder="Ej: Préstamos, Marketing, etc."
                class="border border-gray-300 rounded px-3 py-2 w-full focus:border-purple-500 focus:outline-none"
                maxlength="30" required>
            </div>

            <!-- Icono (selector simple) -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Ícono</label>
              <div id="iconSelector" class="grid grid-cols-8 gap-2">
                <!-- Íconos comunes -->
                <button type="button"
                  class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                  onclick="selectIcon('💳')">💳</button>
                <button type="button"
                  class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                  onclick="selectIcon('💰')">💰</button>
                <button type="button"
                  class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                  onclick="selectIcon('💻')">💻</button>
                <button type="button"
                  class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                  onclick="selectIcon('📱')">📱</button>
                <button type="button"
                  class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                  onclick="selectIcon('🏦')">🏦</button>
                <button type="button"
                  class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                  onclick="selectIcon('🏠')">🏠</button>
                <button type="button"
                  class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                  onclick="selectIcon('🎓')">🎓</button>
                <button type="button"
                  class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                  onclick="selectIcon('⚡')">⚡</button>
                <button type="button"
                  class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                  onclick="selectIcon('🔧')">🔧</button>
                <button type="button"
                  class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                  onclick="selectIcon('🛠️')">🛠️</button>
                <button type="button"
                  class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                  onclick="selectIcon('📦')">📦</button>
                <button type="button"
                  class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                  onclick="selectIcon('🎯')">🎯</button>
                <button type="button"
                  class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                  onclick="selectIcon('📊')">📊</button>
                <button type="button"
                  class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                  onclick="selectIcon('💡')">💡</button>
                <button type="button"
                  class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                  onclick="selectIcon('🚀')">🚀</button>
                <button type="button"
                  class="icon-option text-2xl p-2 border rounded hover:bg-purple-100 hover:border-purple-500 transition"
                  onclick="selectIcon('⭐')">⭐</button>
              </div>
              <input type="hidden" id="selectedIcon" value="📌">
            </div>

            <!-- Color -->
            <div>
              <label for="categoryColor" class="block text-sm font-medium text-gray-700 mb-1">Color (opcional)</label>
              <input type="color" id="categoryColor" value="#6b7280"
                class="border border-gray-300 rounded px-3 py-2 w-full h-10">
            </div>

            <!-- Botón Crear -->
            <button type="button" onclick="saveCustomCategory()"
              class="w-full bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
              💾 Crear Categoría
            </button>

          </div>
        </div>

        <!-- Lista de Categorías Personalizadas -->
        <div>
          <h4 class="text-md font-semibold text-gray-900 mb-3">📋 Tus Categorías Personalizadas</h4>
          <div id="customCategoriesList" class="grid grid-cols-2 md:grid-cols-3 gap-3">
            <!-- Se poblará dinámicamente -->
          </div>
        </div>

      </div>

      <!-- Modal Footer -->
      <div class="border-t border-gray-200 px-6 py-4 flex justify-end sticky bottom-0 bg-white">
        <button type="button" onclick="closeCategoryModal()"
          class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
          Cerrar
        </button>
      </div>

    </div>
  </div>

  <!-- 🔧 WORKAROUND: Modal de categorías creado dinámicamente por caché de Firebase -->
  <script src="js/category-modal-dynamic.js"></script>

</body>

</html>